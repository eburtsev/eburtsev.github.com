server {

	listen               443;

	listen               80;

	server_name          hg.server.net;


	ssl                  on;

	ssl_protocols        SSLv3 TLSv1;

	ssl_certificate      /var/www/hosts/hg.server.net/ssl/ssl_certificate.crt;

	ssl_certificate_key  /var/www/hosts/hg.server.net/ssl/ssl_certificate.key;



	root                 /var/www/hosts/hg.server.net/www;

	access_log           /var/www/hosts/hg.server.net/logs/access.log;

	error_log            /var/www/hosts/hg.server.net/logs/error.log;



	# Need for very big files

	client_max_body_size 100m;


	if ( $scheme = "http" ) {

		rewrite ^/(.*)$  https://$host/$1 permanent;

	}


	location / {

		auth_basic                  "Mercurial Repository";

		auth_basic_user_file        /var/www/auth/.htpasswd;

		include     uwsgi_params;

		uwsgi_param REMOTE_PORT     $remote_port;

		uwsgi_param SERVER_PORT     $server_port;

		uwsgi_param SERVER_PROTOCOL $server_protocol;

		uwsgi_param UWSGI_SCHEME    $scheme;

		uwsgi_param SCRIPT_NAME     /;

		uwsgi_param AUTH_USER       $remote_user;

		uwsgi_param REMOTE_USER     $remote_user;

		uwsgi_pass  hgweb;

	}



	location /static/ {

		rewrite       /static/(.*)  /$1 break;

		root          /usr/share/mercurial/templates/static;

		expires 30d;

	}



	location ~ /\. {

		deny all;

	}

}



upstream hgweb {

	server unix:/var/run/uwsgi.hgweb.sock;

}

