<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Eugene Burtsev's blog]]></title>
  <link href="http://eburtsev.github.com/en/atom.xml" rel="self"/>
  <link href="http://eburtsev.github.com/en"/>
  <updated>2012-12-01T00:22:53+04:00</updated>
  <id>http://eburtsev.github.com/en</id>
  <author>
    <name><![CDATA[Eugene Burtsev]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  
  
  
  <entry>
    <title type="html"><![CDATA[Prevent iBatis org.apache.ibatis.transaction. TransactionException if the database connection is temporarily lost]]></title>
    <link href="http://eburtsev.github.com/en/2012/01/12/100/"/>
    <updated>2012-01-12T14:10:00+04:00</updated>
    <id>http://eburtsev.github.com/en/2012/01/12/100</id>
    <content type="html"><![CDATA[<p>Sometimes there is an unpleasant situation when the database server goes to reboot.
In this case, we can catch a nasty exception like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>Caused by: org.apache.ibatis.exceptions.PersistenceException:
</span><span class='line'>### Error opening session.  Cause: org.apache.ibatis.transaction.TransactionException: Error configuring AutoCommit.  Your driver may not support getAutoCommit() or setAutoCommit(). Requested setting: false.  Cause: com.mysql.jdbc.exceptions.jdbc4.CommunicationsException: The last packet successfully received from the server was 59,121,876 milliseconds ago.  The last packet sent successfully to the server was 59,121,984 milliseconds ago. is longer than the server configured value of &#39;wait_timeout&#39;. You should consider either expiring and/or testing connection validity before use in your application, increasing the server configured values for client timeouts, or using the Connector/J connection property &#39;autoReconnect=true&#39; to avoid this problem.
</span><span class='line'>### Cause: org.apache.ibatis.transaction.TransactionException: Error configuring AutoCommit.  Your driver may not support getAutoCommit() or setAutoCommit(). Requested setting: false.  Cause: com.mysql.jdbc.exceptions.jdbc4.CommunicationsException: The last packet successfully received from the server was 59,121,876 milliseconds ago.  The last packet sent successfully to the server was 59,121,984 milliseconds ago. is longer than the server configured value of &#39;wait_timeout&#39;. You should consider either expiring and/or testing connection validity before use in your application, increasing the server configured values for client timeouts, or using the Connector/J connection property &#39;autoReconnect=true&#39; to avoid this problem.
</span><span class='line'>        at org.apache.ibatis.exceptions.ExceptionFactory.wrapException(ExceptionFactory.java:8)
</span><span class='line'>        at org.apache.ibatis.session.defaults.DefaultSqlSessionFactory.openSessionFromDataSource(DefaultSqlSessionFactory.java:83)
</span><span class='line'>        at org.apache.ibatis.session.defaults.DefaultSqlSessionFactory.openSession(DefaultSqlSessionFactory.java:32)
</span><span class='line'>        at com.greytower.htmltemplates.core.dao.ibatis.TemplatesDAOImpl.readAll(TemplatesDAOImpl.java:70)
</span><span class='line'>        at com.greytower.htmltemplates.beans.TemplatesEditorBean.init(TemplatesEditorBean.java:86)
</span><span class='line'>        ... 59 more
</span><span class='line'>Caused by: org.apache.ibatis.transaction.TransactionException: Error configuring AutoCommit.  Your driver may not support getAutoCommit() or setAutoCommit(). Requested setting: false.  Cause: com.mysql.jdbc.exceptions.jdbc4.CommunicationsException: The last packet successfully received from the server was 59,121,876 milliseconds ago.  The last packet sent successfully to the server was 59,121,984 milliseconds ago. is longer than the server configured value of &#39;wait_timeout&#39;. You should consider either expiring and/or testing connection validity before use in your application, increasing the server configured values for client timeouts, or using the Connector/J connection property &#39;autoReconnect=true&#39; to avoid this problem.
</span><span class='line'>        at org.apache.ibatis.transaction.jdbc.JdbcTransaction.setDesiredAutoCommit(JdbcTransaction.java:51)
</span><span class='line'>        at org.apache.ibatis.transaction.jdbc.JdbcTransaction.&lt;init&gt;(JdbcTransaction.java:19)
</span><span class='line'>        at org.apache.ibatis.transaction.jdbc.JdbcTransactionFactory.newTransaction(JdbcTransactionFactory.java:15)
</span><span class='line'>        at org.apache.ibatis.session.defaults.DefaultSqlSessionFactory.openSessionFromDataSource(DefaultSqlSessionFactory.java:78)
</span><span class='line'>        ... 62 more
</span><span class='line'>Caused by: com.mysql.jdbc.exceptions.jdbc4.CommunicationsException: The last packet successfully received from the server was 59,121,876 milliseconds ago.  The last packet sent successfully to the server was 59,121,984 milliseconds ago. is longer than the server configured value of &#39;wait_timeout&#39;. You should consider either expiring and/or testing connection validity before use in your application, increasing the server configured values for client timeouts, or using the Connector/J connection property &#39;autoReconnect=true&#39; to avoid this problem.
</span></code></pre></td></tr></table></div></figure>


<!--more-->


<p>To solve this problem you need to set the poolPingQuery and poolPingEnabled properties in the iBatis config file. For example, see lines 17 and 18 in code below.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
</span><span class='line'><span class="cp">&lt;!DOCTYPE configuration PUBLIC &quot;-//mybatis.org//DTD Config 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;&gt;</span>
</span><span class='line'><span class="nt">&lt;configuration&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;typeAliases&gt;</span>
</span><span class='line'>      ...
</span><span class='line'>  <span class="nt">&lt;/typeAliases&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;environments</span> <span class="na">default=</span><span class="s">&quot;development&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;environment</span> <span class="na">id=</span><span class="s">&quot;development&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>          <span class="nt">&lt;transactionManager</span> <span class="na">type=</span><span class="s">&quot;JDBC&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>          <span class="nt">&lt;dataSource</span> <span class="na">type=</span><span class="s">&quot;POOLED&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>              <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;driver&quot;</span> <span class="na">value=</span><span class="s">&quot;${db.driver}&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>              <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;url&quot;</span> <span class="na">value=</span><span class="s">&quot;${db.url}&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>              <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;username&quot;</span> <span class="na">value=</span><span class="s">&quot;${db.user}&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>              <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;password&quot;</span> <span class="na">value=</span><span class="s">&quot;${db.password}&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>              <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;poolPingQuery&quot;</span> <span class="na">value=</span><span class="s">&quot;SELECT id FROM user WHERE id = 1&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>              <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;poolPingEnabled&quot;</span> <span class="na">value=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>          <span class="nt">&lt;/dataSource&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/environment&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/environments&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;/configuration&gt;</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  
  
  <entry>
    <title type="html"><![CDATA[PrimeFaces tips & tricks]]></title>
    <link href="http://eburtsev.github.com/en/2011/10/02/63/"/>
    <updated>2011-10-02T13:00:00+04:00</updated>
    <id>http://eburtsev.github.com/en/2011/10/02/63</id>
    <content type="html"><![CDATA[<p>Below I will describe solutions to common problems occurring working with <a href="http://primefaces.org">PrimeFaces</a> JSF components library.</p>

<!--more-->


<h2>Components size</h2>

<p>Probably everyone who started to use the library asked the question &#8220;Why components look so huge?&#8221;.
To solve this problem, just add following CSS code inside <code>&lt;h:head&gt;&lt;/h:head&gt;</code> tag:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="nc">.ui-widget</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">font-size</span><span class="o">:</span> <span class="m">75</span><span class="o">%</span> <span class="cp">!important</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nc">.ui-widget</span> <span class="nc">.ui-widget</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">font-size</span><span class="o">:</span> <span class="m">100</span><span class="o">%</span> <span class="cp">!important</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>PrimeFaces vs Internet Explorer</h2>

<p>Internet Explorer may incorrectly render pages in which you using PrimeFaces components. To solve this problem is recommended to set the X-UA-Compatible header. In old versions of this library (&lt; 3.0) you can make this by adding meta tag in <code>&lt;h:head&gt;&lt;/h:head&gt;</code> tag first. But in newest versions library first renders own code in head tag, and next user code. For solve this in version 3.0 introduced the &#8220;first&#8221; facet, which renders exactly first in head tag:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;h:head&gt;</span>
</span><span class='line'>  <span class="nt">&lt;f:facet</span> <span class="na">name=</span><span class="s">&quot;first&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;X-UA-Compatible&quot;</span> <span class="na">content=</span><span class="s">&quot;EmulateIE8&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>      <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;Content-Type&quot;</span> <span class="na">content=</span><span class="s">&quot;text/xhtml; charset=UTF-8&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>      <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;Cache-Control&quot;</span> <span class="na">content=</span><span class="s">&quot;no-cache&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>      <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;Pragma&quot;</span> <span class="na">content=</span><span class="s">&quot;no-cache&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>      <span class="nt">&lt;title&gt;&lt;ui:insert</span> <span class="na">name=</span><span class="s">&quot;title&quot;</span><span class="nt">&gt;</span>Application Title<span class="nt">&lt;/ui:insert&gt;&lt;/title&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/f:facet&gt;</span>
</span><span class='line'><span class="nt">&lt;/h:head&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Vertical tabs in p:tabView</h2>

<p>Because this library based on jQueryUI, for create vertical tabs we can use <a href="http://jquery-ui.googlecode.com/svn/trunk/demos/tabs/vertical.html">this demo</a> as solution. First add following CSS:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="c">/* Vertical Tabs</span>
</span><span class='line'><span class="c">----------------------------------*/</span>
</span><span class='line'><span class="nc">.ui-tabs-vertical</span> <span class="p">{</span> <span class="k">width</span><span class="o">:</span> <span class="m">55em</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="nc">.ui-tabs-vertical</span> <span class="nc">.ui-tabs-nav</span> <span class="p">{</span> <span class="k">padding</span><span class="o">:</span> <span class="m">.2em</span> <span class="m">.1em</span> <span class="m">.2em</span> <span class="m">.2em</span><span class="p">;</span> <span class="k">float</span><span class="o">:</span> <span class="k">left</span><span class="p">;</span> <span class="k">width</span><span class="o">:</span> <span class="m">12em</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="nc">.ui-tabs-vertical</span> <span class="nc">.ui-tabs-nav</span> <span class="nt">li</span> <span class="p">{</span> <span class="k">clear</span><span class="o">:</span> <span class="k">left</span><span class="p">;</span> <span class="k">width</span><span class="o">:</span> <span class="m">100</span><span class="o">%</span><span class="p">;</span> <span class="k">border-bottom-width</span><span class="o">:</span> <span class="m">1px</span> <span class="cp">!important</span><span class="p">;</span> <span class="k">border-right</span><span class="o">-</span><span class="k">width</span><span class="o">:</span> <span class="m">0</span> <span class="cp">!important</span><span class="p">;</span> <span class="k">margin</span><span class="o">:</span> <span class="m">0</span> <span class="m">-1px</span> <span class="m">.2em</span> <span class="m">0</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="nc">.ui-tabs-vertical</span> <span class="nc">.ui-tabs-nav</span> <span class="nt">li</span> <span class="nt">a</span> <span class="p">{</span> <span class="k">display</span><span class="o">:</span><span class="k">block</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="nc">.ui-tabs-vertical</span> <span class="nc">.ui-tabs-nav</span> <span class="nt">li</span><span class="nc">.ui-tabs-selected</span> <span class="p">{</span> <span class="k">padding-bottom</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span> <span class="k">padding-right</span><span class="o">:</span> <span class="m">.1em</span><span class="p">;</span> <span class="k">border-right</span><span class="o">-</span><span class="k">width</span><span class="o">:</span> <span class="m">1px</span><span class="p">;</span> <span class="k">border-right</span><span class="o">-</span><span class="k">width</span><span class="o">:</span> <span class="m">1px</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="nc">.ui-tabs-vertical</span> <span class="nc">.ui-tabs-panel</span> <span class="p">{</span> <span class="k">padding</span><span class="o">:</span> <span class="m">1em</span><span class="p">;</span> <span class="k">float</span><span class="o">:</span> <span class="k">right</span><span class="p">;</span> <span class="k">width</span><span class="o">:</span> <span class="m">40em</span><span class="p">;}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And add styleClass property to your tabView:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;p:tabView</span> <span class="na">styleClass=</span><span class="s">&quot;ui-tabs-vertical&quot;</span> <span class="nt">/&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&#8217;s it ;)
This solution based on following questions on <a href="http://stackowerflow.com">StackOverflow</a>:
*   <a href="http://stackoverflow.com/q/6098319/600313">Make tabs appear vertically on the side when using PrimeFaces TabView</a>
*   <a href="http://stackoverflow.com/q/773074/600313">Vertical Tabs with JQuery?</a></p>
]]></content>
  </entry>
  
  
  
  
  
  
  
  <entry>
    <title type="html"><![CDATA[Installation of Mercurial + UWSGI + Nginx + HTTPS on Ubuntu Server 10.04]]></title>
    <link href="http://eburtsev.github.com/en/2011/08/03/13/"/>
    <updated>2011-08-03T20:28:00+04:00</updated>
    <id>http://eburtsev.github.com/en/2011/08/03/13</id>
    <content type="html"><![CDATA[<p>Some times ago I installed Mercurial server, using as a frontend nginx. Internet has a lot of information about this, but I had to improvise a lot that would achieve a result. So, here is the result of my work.</p>

<!--more-->


<p>All commands in this guide you need to run with root rights. Let&#8217;s go :)</p>

<h2>Install required software</h2>

<h3>Python</h3>

<p>Install Python first time.</p>

<pre><code>apt-get install python
</code></pre>

<p>Install python-software-properties - this is best way for adding PPA :)</p>

<pre><code>apt-get install python-software-properties
</code></pre>

<p>After installing it you can add PPA by following command. It&#8217;s really simple.</p>

<pre><code>add-apt-repository ppa:xxx/yyy
</code></pre>

<h3>Mercurial</h3>

<p>In Lucid Lynx repository mercurial present, but it&#8217;s version is too old, so install third-party PPA with newest versions of mercurial:</p>

<pre><code>add-apt-repository ppa:mercurial-ppa/stable-snapshots
apt-get update
apt-get install mercurial
</code></pre>

<h3>Nginx</h3>

<p>Install nginx from third-party PPA.</p>

<pre><code>add-apt-repository ppa:nginx/stable
apt-get update
apt-get install nginx
</code></pre>

<h3>uwsgi-python</h3>

<p>Install uwsgi-python as python application server.</p>

<pre><code>add-apt-repository ppa:uwsgi/release
apt-get update
apt-get install uwsgi-python
</code></pre>

<h2>Configuration</h2>

<p>After software installation go to the next step - configuration.
First, review directories structure used in this guide.</p>

<pre><code>/var/www/hosts/hg.server.net/conf    здесь будут расположены конфиги
/var/www/hosts/hg.server.net/logs    директория для логов
/var/www/hosts/hg.server.net/repos   директория, содержащая репозитории
</code></pre>

<h3>Mercurial + uwsgi</h3>

<p>Create UWSGI-application <code>/etc/uwsgi-python/apps-available/hgweb.xml</code>:</p>

<figure class='code'><figcaption><span>hgweb.xml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;uwsgi&gt;</span>
</span><span class='line'>  <span class="nt">&lt;socket&gt;</span>/var/run/uwsgi.hgweb.sock<span class="nt">&lt;/socket&gt;</span>
</span><span class='line'>  <span class="nt">&lt;master/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;workers&gt;</span>2<span class="nt">&lt;/workers&gt;</span>
</span><span class='line'>  <span class="cp">&lt;![CDATA[</span>
</span><span class='line'><span class="cp">     import uwsgi</span>
</span><span class='line'><span class="cp">     import os</span>
</span><span class='line'>
</span><span class='line'><span class="cp">     os.environ[&quot;HGENCODING&quot;] = &quot;UTF-8&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">     from mercurial import demandimport; demandimport.enable()</span>
</span><span class='line'><span class="cp">     from mercurial.hgweb.hgwebdir_mod import hgwebdir</span>
</span><span class='line'>
</span><span class='line'><span class="cp">     application = hgwebdir(&#39;/var/www/hosts/hg.server.net/conf/hgweb.config&#39;)</span>
</span><span class='line'><span class="cp"> ]]&gt;</span>
</span><span class='line'><span class="nt">&lt;/uwsgi&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that in 14-th line you need change path to hgweb config, which we create now.</p>

<p>Create file <code>/var/www/hosts/hg.server.net/conf/hgweb.config</code>:</p>

<figure class='code'><figcaption><span>hgweb.config</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ini'><span class='line'><span class="k">[web]</span>
</span><span class='line'><span class="na">push_ssl</span> <span class="o">=</span> <span class="s">true</span>
</span><span class='line'><span class="na">allow_push</span> <span class="o">=</span> <span class="s">*</span>
</span><span class='line'><span class="na">style</span> <span class="o">=</span> <span class="s">gitweb</span>
</span><span class='line'><span class="na">allow_archive</span> <span class="o">=</span> <span class="s">gz, zip, bz2</span>
</span><span class='line'>
</span><span class='line'><span class="k">[collections]</span>
</span><span class='line'><span class="na">/var/www/hosts/hg.server.net/repos/</span> <span class="o">=</span> <span class="s">/var/www/hosts/hg.server.net/repos/</span>
</span></code></pre></td></tr></table></div></figure>


<p>In last line you need change patchs to repositories dir.
Now we can check how works uwsgi server. For test change line <code>&lt;socket&gt;/var/run/uwsgi.hgweb.sock&lt;/socket&gt;</code> in hgweb.xml file to <code>&lt;socket&gt;127.0.0.1:3031&lt;/socket&gt;</code> and run:</p>

<pre><code>uwsgi-python -x /etc/uwsgi-python/apps-available/hgweb.xml
</code></pre>

<p>If all is OK you can go to <code>http://127.0.0.1:3031/</code> and see repositories list. If it&#8217;s true, revert hgweb.xml and make symlink to <code>/etc/uwsgi-python/apps-enabled</code>:</p>

<pre><code>ln -s /etc/uwsgi-python/apps-{available,enabled}/hgweb.xml
</code></pre>

<p>Now we can go to next step.</p>

<h3>Nginx</h3>

<p>Create auth file with htpasswd utility</p>

<pre><code>htpasswd -c /var/www/auth/.htpasswd &lt;username&gt;
</code></pre>

<p>Create nginx config /etc/nginx/sites-available/hg.server.net</p>

<figure class='code'><figcaption><span>hg.server.net</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class='nginx'><span class='line'><span class="k">server</span> <span class="p">{</span>
</span><span class='line'>  <span class="kn">listen</span>               <span class="mi">443</span><span class="p">;</span>
</span><span class='line'>  <span class="kn">listen</span>               <span class="mi">80</span><span class="p">;</span>
</span><span class='line'>  <span class="kn">server_name</span>          <span class="s">hg.server.net</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kn">ssl</span>                  <span class="no">on</span><span class="p">;</span>
</span><span class='line'>  <span class="kn">ssl_protocols</span>        <span class="s">SSLv3</span> <span class="s">TLSv1</span><span class="p">;</span>
</span><span class='line'>  <span class="kn">ssl_certificate</span>      <span class="s">/var/www/hosts/hg.server.net/ssl/ssl_certificate.crt</span><span class="p">;</span>
</span><span class='line'>  <span class="kn">ssl_certificate_key</span>  <span class="s">/var/www/hosts/hg.server.net/ssl/ssl_certificate.key</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kn">root</span>                 <span class="s">/var/www/hosts/hg.server.net/www</span><span class="p">;</span>
</span><span class='line'>  <span class="kn">access_log</span>           <span class="s">/var/www/hosts/hg.server.net/logs/access.log</span><span class="p">;</span>
</span><span class='line'>  <span class="kn">error_log</span>            <span class="s">/var/www/hosts/hg.server.net/logs/error.log</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Need for very big files</span>
</span><span class='line'>  <span class="kn">client_max_body_size</span> <span class="mi">100m</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kn">if</span> <span class="s">(</span> <span class="nv">$scheme</span> <span class="p">=</span> <span class="s">&quot;http&quot;</span> <span class="s">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kn">rewrite</span> <span class="s">^/(.*)</span>$  <span class="s">https://</span><span class="nv">$host/$1</span> <span class="s">permanent</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
</span><span class='line'>      <span class="kn">auth_basic</span>                  <span class="s">&quot;Mercurial</span> <span class="s">Repository&quot;</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">auth_basic_user_file</span>        <span class="s">/var/www/auth/.htpasswd</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">include</span>     <span class="s">uwsgi_params</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">uwsgi_param</span> <span class="s">REMOTE_PORT</span>     <span class="nv">$remote_port</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">uwsgi_param</span> <span class="s">SERVER_PORT</span>     <span class="nv">$server_port</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">uwsgi_param</span> <span class="s">SERVER_PROTOCOL</span> <span class="nv">$server_protocol</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">uwsgi_param</span> <span class="s">UWSGI_SCHEME</span>    <span class="nv">$scheme</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">uwsgi_param</span> <span class="s">SCRIPT_NAME</span>     <span class="s">/</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">uwsgi_param</span> <span class="s">AUTH_USER</span>       <span class="nv">$remote_user</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">uwsgi_param</span> <span class="s">REMOTE_USER</span>     <span class="nv">$remote_user</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">uwsgi_pass</span>  <span class="s">hgweb</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kn">location</span> <span class="s">/static/</span> <span class="p">{</span>
</span><span class='line'>      <span class="kn">rewrite</span>       <span class="s">/static/(.*)</span>  <span class="s">/</span><span class="nv">$1</span> <span class="s">break</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">root</span>          <span class="s">/usr/share/mercurial/templates/static</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">expires</span> <span class="s">30d</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kn">location</span> <span class="p">~</span> <span class="sr">/\.</span> <span class="p">{</span>
</span><span class='line'>      <span class="kn">deny</span> <span class="s">all</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">upstream</span> <span class="s">hgweb</span> <span class="p">{</span>
</span><span class='line'>  <span class="kn">server</span> <span class="s">unix:/var/run/uwsgi.hgweb.sock</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Make symlink for config in <code>/etc/nginx/sites-enabled</code> directory:</p>

<pre><code>ln -s /etc/nginx/sites-{available,enabled}/hg.server.net
</code></pre>

<p>Start services:</p>

<pre><code>service uwsgi-python start
service nginx start
</code></pre>

<p>Try open <code>http://hg.server.net/</code> in browser. All is OK if you see list of repositories. If you get an error - check settings.
Next we can add all services to autorun.</p>

<h3>Auto start services at boot</h3>

<p>First, make symlinks to configs as I write in examples below.
Then configure required services for auto start at boot:</p>

<pre><code>update-rc.d uwsgi-python defaults
update-rc.d nginx defaults
</code></pre>

<p>That&#8217;s it. You can reboot and check how it works.</p>
]]></content>
  </entry>
  
  
</feed>

