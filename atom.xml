<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Eugene Burtsev's blog]]></title>
  <link href="http://burtsev.net/atom.xml" rel="self"/>
  <link href="http://burtsev.net/"/>
  <updated>2013-03-26T10:34:43+04:00</updated>
  <id>http://burtsev.net/</id>
  <author>
    <name><![CDATA[Eugene Burtsev]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  
  <entry>
    <title type="html"><![CDATA[Maven custom repository layout]]></title>
    <link href="http://burtsev.net/2012/11/10/maven-custom-repository-layout/"/>
    <updated>2012-11-10T08:42:00+04:00</updated>
    <id>http://burtsev.net/2012/11/10/maven-custom-repository-layout</id>
    <content type="html"><![CDATA[<p>Приветствую всех.</p>

<p>Хочу поделиться с сообществом небольшим велосипедом - расширением для мавена позволяющим получать доступ к репозиториям с кастомной структурой.</p>

<p>Для начала расскажу как я до такого докатился. В процессе работы над проектом пришла мысль о том зависимости JavaScript типа JQuery ничем не управляются, и при обновлении приходится качать библиотеки вручную, что совершенно не впечатляет. И вот так появилось дикое желание найти какой-нибудь менеджер зависимостей но для javascript. В первую очередь в своих поисках я наткнулся на <a href="http://twitter.github.com/bower/">Bower</a> но необходимость введения дополнительного шага в процессе сборки отпугивало как node.js в зависимостях. Тут я вспомнил про CDN с коих можно невозбранно тянуть js-библиотеки (например jquery на Google CDN: <a href="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js">http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js</a>). Поскольку в проекте используется maven для сборки то логичной мыслью было натравить его на эти залежи библиотек&#8230; Но все оказалось не так просто. Дело в том что структура файловой системы CDN отличается от стандартной для для maven. После 2 часов поиска решения на просторах интернетов найдено не было,и решил я написать свой велосипед. Если я еще не утомил вас то прошу под кат.</p>

<!-- more -->


<p>В процессе поиска готовых решений было замечено что можно написать расширение для maven обрабатывающее кастомный тип репозиториев. Правда не смотря на то что везде писалось что сделать можно, как это сделать нигде написано не было. Только однажды промелькнуло то что для этой цели служит интерфейс RepositoryConnectorFactory. На скорую руку был набросан простенький класс реализующий данный интерфейс:</p>

<figure class='code'><figcaption><span>CustomRepositoryConnectorFactory.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Component</span><span class="o">(</span><span class="n">role</span> <span class="o">=</span> <span class="n">RepositoryConnectorFactory</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">hint</span> <span class="o">=</span> <span class="s">&quot;custom&quot;</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomRepositoryConnectorFactory</span> <span class="kd">implements</span> <span class="n">RepositoryConnectorFactory</span><span class="o">,</span> <span class="n">Service</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="nd">@Override</span>
</span><span class='line'>        <span class="kd">public</span> <span class="n">RepositoryConnector</span> <span class="nf">newInstance</span><span class="o">(</span><span class="n">RepositorySystemSession</span> <span class="n">session</span><span class="o">,</span>
</span><span class='line'>                <span class="n">RemoteRepository</span> <span class="n">repository</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">NoRepositoryConnectorException</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;CustomRepositoryConnectorFactory.newInstance()&quot;</span><span class="o">);</span>
</span><span class='line'>                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="nd">@Override</span>
</span><span class='line'>        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getPriority</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>                <span class="k">return</span> <span class="mi">1</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="nd">@Override</span>
</span><span class='line'>        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initService</span><span class="o">(</span><span class="n">ServiceLocator</span> <span class="n">locator</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Однако после подключения расширения к проекту, чуда не случилось - расширение не вызывалось, а мавен продолжал ругаться на не поддерживаемый тип репозитория. Как в оказалось дальнейшем для правильной работы расширения необходимо сгенерировать описание компонента в файле META-INF/plexus/components.xml. Для создания которого, можно воспользоваться плагином plexus-component-metadata, который распарсит аннотации к классам и создаст этот волшебный файлик.</p>

<figure class='code'><figcaption><span>components.xml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'>    <span class="nt">&lt;plugin&gt;</span>
</span><span class='line'>            <span class="nt">&lt;groupId&gt;</span>org.codehaus.plexus<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>            <span class="nt">&lt;artifactId&gt;</span>plexus-component-metadata<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>            <span class="nt">&lt;version&gt;</span>1.5.5<span class="nt">&lt;/version&gt;</span>
</span><span class='line'>            <span class="nt">&lt;executions&gt;</span>
</span><span class='line'>                    <span class="nt">&lt;execution&gt;</span>
</span><span class='line'>                            <span class="nt">&lt;goals&gt;</span>
</span><span class='line'>                                    <span class="nt">&lt;goal&gt;</span>generate-metadata<span class="nt">&lt;/goal&gt;</span>
</span><span class='line'>                            <span class="nt">&lt;/goals&gt;</span>
</span><span class='line'>                    <span class="nt">&lt;/execution&gt;</span>
</span><span class='line'>            <span class="nt">&lt;/executions&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/plugin&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>После включения генерации components.xml и установки плагина в локальный репозиторий все заработало.</p>

<p>Теперь расскажу как использовать это безобразие. В первую очередь подключаем репозиторий с плагином (пока что я выложил в своем репозитории, в дальнейшем буду думать как поместить в Maven Central):</p>

<figure class='code'><figcaption><span>pom.xml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;pluginRepositories&gt;</span>
</span><span class='line'>  <span class="nt">&lt;pluginRepository&gt;</span>
</span><span class='line'>      <span class="nt">&lt;id&gt;</span>maven-burtsev-net<span class="nt">&lt;/id&gt;</span>
</span><span class='line'>      <span class="nt">&lt;url&gt;</span>http://maven.burtsev.net<span class="nt">&lt;/url&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/pluginRepository&gt;</span>
</span><span class='line'><span class="nt">&lt;/pluginRepositories&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>И включаем расширение в секции build pom.xml:</p>

<figure class='code'><figcaption><span>pom.xml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;build&gt;</span>
</span><span class='line'>  <span class="nt">&lt;extensions&gt;</span>
</span><span class='line'>      <span class="nt">&lt;extension&gt;</span>
</span><span class='line'>          <span class="nt">&lt;groupId&gt;</span>net.burtsev.maven<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>          <span class="nt">&lt;artifactId&gt;</span>maven-custom-repository-layout<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>          <span class="nt">&lt;version&gt;</span>1.0<span class="nt">&lt;/version&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/extension&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/extensions&gt;</span>
</span><span class='line'><span class="nt">&lt;/build&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Подключаем необходимые репозитории, например так:</p>

<figure class='code'><figcaption><span>pom.xml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;repository&gt;</span>
</span><span class='line'>  <span class="nt">&lt;id&gt;</span>google-cdn<span class="nt">&lt;/id&gt;</span>
</span><span class='line'>  <span class="nt">&lt;url&gt;</span>http://ajax.googleapis.com/ajax/libs/$groupId/$version/$artifactId${classifier(prefix:.)}.$extension<span class="nt">&lt;/url&gt;</span>
</span><span class='line'>  <span class="nt">&lt;layout&gt;</span>custom<span class="nt">&lt;/layout&gt;</span>
</span><span class='line'><span class="nt">&lt;/repository&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>В URL репозитория указываются подстановочные символы которые будут заменены на соответствующие параметры для закачиваемого артифакта. Привожу список всех поддерживаемых подстановочных символов:</p>

<ul>
<li>$groupId</li>
<li>$artifactId</li>
<li>$version</li>
<li>$classifier</li>
<li>$extension</li>
</ul>


<p>Для параметров значение которых может быть пустым доступен альтернативный синтаксис: <code>${classifier(prefix:.)}</code>. Это сделано для того что бы не дублировать разделители в URL в случае пустого значения параметра.</p>

<p>После подключения репозитория подключаем зависомости например так:</p>

<figure class='code'><figcaption><span>pom.xml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;dependencies&gt;</span>
</span><span class='line'>  <span class="nt">&lt;dependency&gt;</span>
</span><span class='line'>      <span class="nt">&lt;groupId&gt;</span>jquery<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>      <span class="nt">&lt;artifactId&gt;</span>jquery<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>      <span class="nt">&lt;version&gt;</span>1.8.2<span class="nt">&lt;/version&gt;</span>
</span><span class='line'>      <span class="nt">&lt;classifier&gt;</span>min<span class="nt">&lt;/classifier&gt;</span>
</span><span class='line'>      <span class="nt">&lt;type&gt;</span>js<span class="nt">&lt;/type&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/dependency&gt;</span>
</span><span class='line'><span class="nt">&lt;/dependencies&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Для копирования загруженных библиотек в папку веб приложения используем maven-dependency-plugin:</p>

<figure class='code'><figcaption><span>pom.xml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;plugins&gt;</span>
</span><span class='line'>  <span class="nt">&lt;plugin&gt;</span>
</span><span class='line'>      <span class="nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>      <span class="nt">&lt;artifactId&gt;</span>maven-dependency-plugin<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>      <span class="nt">&lt;executions&gt;</span>
</span><span class='line'>          <span class="nt">&lt;execution&gt;</span>
</span><span class='line'>              <span class="nt">&lt;id&gt;</span>copy-dependencies<span class="nt">&lt;/id&gt;</span>
</span><span class='line'>              <span class="nt">&lt;phase&gt;</span>generate-resources<span class="nt">&lt;/phase&gt;</span>
</span><span class='line'>              <span class="nt">&lt;goals&gt;</span>
</span><span class='line'>                  <span class="nt">&lt;goal&gt;</span>copy-dependencies<span class="nt">&lt;/goal&gt;</span>
</span><span class='line'>              <span class="nt">&lt;/goals&gt;</span>
</span><span class='line'>              <span class="nt">&lt;configuration&gt;</span>
</span><span class='line'>                  <span class="nt">&lt;outputDirectory&gt;</span>${project.build.directory}/${project.build.finalName}/js<span class="nt">&lt;/outputDirectory&gt;</span>
</span><span class='line'>                  <span class="nt">&lt;includeArtifactIds&gt;</span>jquery<span class="nt">&lt;/includeArtifactIds&gt;</span>
</span><span class='line'>                  <span class="nt">&lt;includeTypes&gt;</span>js<span class="nt">&lt;/includeTypes&gt;</span>
</span><span class='line'>              <span class="nt">&lt;/configuration&gt;</span>
</span><span class='line'>          <span class="nt">&lt;/execution&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/executions&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/plugin&gt;</span>
</span><span class='line'><span class="nt">&lt;/plugins&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Собственно все. Проблема решена - мы добились возможности рулить JS зависимостями с помощью maven.</p>

<p>Исходные коды плагина можно найти здесь: <a href="https://bitbucket.org/eburtsev/maven-custom-repository-layout">https://bitbucket.org/eburtsev/maven-custom-repository-layout</a>
Сам плагин можно использовать напрямую из моего репозитория maven: <a href="http://maven.burtsev.net/">http://maven.burtsev.net/</a>
Пример проекта с использованием описываемого расширения <a href="https://bitbucket.org/eburtsev/test-javascript-dependencies">https://bitbucket.org/eburtsev/test-javascript-dependencies</a></p>
]]></content>
  </entry>
  
  
  
  
  
  <entry>
    <title type="html"><![CDATA[Пример совместной работы JSF2 и Spring Framework]]></title>
    <link href="http://burtsev.net/2012/05/30/192/"/>
    <updated>2012-05-30T21:19:00+04:00</updated>
    <id>http://burtsev.net/2012/05/30/192</id>
    <content type="html"><![CDATA[<p>Совсем недавно открыл для себя Spring Framework и понял, что до этого момента упускал множество возможностей. По это причине решил переписать парочку приложений с использованием Spring. Ниже я расскажу как интегрировать Spring и JSF2</p>

<!--more-->


<h2>Подключение зависимостей</h2>

<p>В первую очередь необходимо добавить в зависимости проекта артефакт org.springframework:spring-web:</p>

<figure class='code'><figcaption><span>pom.xml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;dependency&gt;</span>
</span><span class='line'>  <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>  <span class="nt">&lt;artifactId&gt;</span>spring-web<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>  <span class="nt">&lt;version&gt;</span>3.1.1.RELEASE<span class="nt">&lt;/version&gt;</span>
</span><span class='line'><span class="nt">&lt;/dependency&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Остальные необходимые зависимости maven подтянет сам.</p>

<h2>Настройка</h2>

<p>Чтобы все заработало нужно настроить слушателей в web.xml, как показано в примере ниже:</p>

<figure class='code'><figcaption><span>web.xml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
</span><span class='line'><span class="nt">&lt;web-app</span> <span class="na">xmlns=</span><span class="s">&quot;http://java.sun.com/xml/ns/javaee&quot;</span>
</span><span class='line'>      <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
</span><span class='line'>      <span class="na">xmlns:web=</span><span class="s">&quot;http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd&quot;</span>
</span><span class='line'>      <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd&quot;</span>
</span><span class='line'>      <span class="na">id=</span><span class="s">&quot;jsf2-spring-example&quot;</span> <span class="na">version=</span><span class="s">&quot;2.5&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;display-name&gt;</span>jsf2-spring-example Application<span class="nt">&lt;/display-name&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;listener&gt;</span>
</span><span class='line'>      <span class="nt">&lt;listener-class&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="nt">&lt;/listener-class&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/listener&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;listener&gt;</span>
</span><span class='line'>      <span class="nt">&lt;listener-class&gt;</span>org.springframework.web.context.request.RequestContextListener<span class="nt">&lt;/listener-class&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/listener&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;context-param&gt;</span>
</span><span class='line'>      <span class="nt">&lt;param-name&gt;</span>contextConfigLocation<span class="nt">&lt;/param-name&gt;</span>
</span><span class='line'>      <span class="nt">&lt;param-value&gt;</span>classpath:spring-context.xml<span class="nt">&lt;/param-value&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/context-param&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;servlet&gt;</span>
</span><span class='line'>      <span class="nt">&lt;servlet-name&gt;</span>Faces Servlet<span class="nt">&lt;/servlet-name&gt;</span>
</span><span class='line'>      <span class="nt">&lt;servlet-class&gt;</span>javax.faces.webapp.FacesServlet<span class="nt">&lt;/servlet-class&gt;</span>
</span><span class='line'>      <span class="nt">&lt;load-on-startup&gt;</span>1<span class="nt">&lt;/load-on-startup&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/servlet&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;servlet-mapping&gt;</span>
</span><span class='line'>      <span class="nt">&lt;servlet-name&gt;</span>Faces Servlet<span class="nt">&lt;/servlet-name&gt;</span>
</span><span class='line'>      <span class="nt">&lt;url-pattern&gt;</span>*.jsf<span class="nt">&lt;/url-pattern&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/servlet-mapping&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;servlet-mapping&gt;</span>
</span><span class='line'>      <span class="nt">&lt;servlet-name&gt;</span>Faces Servlet<span class="nt">&lt;/servlet-name&gt;</span>
</span><span class='line'>      <span class="nt">&lt;url-pattern&gt;</span>/faces/*<span class="nt">&lt;/url-pattern&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/servlet-mapping&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;/web-app&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Так же необходимо установить el-resolver из Spring взамен стандартного, чтобы дать возможность спрингу рулить бинами. Для этого меняем faces-config.xml:</p>

<figure class='code'><figcaption><span>faces-config.xml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot;?&gt;</span>
</span><span class='line'><span class="nt">&lt;faces-config</span> <span class="na">version=</span><span class="s">&quot;2.0&quot;</span> <span class="na">xmlns=</span><span class="s">&quot;http://java.sun.com/xml/ns/javaee&quot;</span> <span class="na">xmlns:xi=</span><span class="s">&quot;http://www.w3.org/2001/XInclude&quot;</span>
</span><span class='line'>    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-facesconfig_2_0.xsd&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;application&gt;</span>
</span><span class='line'>      <span class="nt">&lt;el-resolver&gt;</span>org.springframework.web.jsf.el.SpringBeanFacesELResolver<span class="nt">&lt;/el-resolver&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/application&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;/faces-config&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Теперь настроим spring-context.xml. Собственно тут все сводится к изменению значения base-package для context:component-scan:</p>

<figure class='code'><figcaption><span>spring-context.xml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
</span><span class='line'><span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span> <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
</span><span class='line'>  <span class="na">xmlns:context=</span><span class="s">&quot;http://www.springframework.org/schema/context&quot;</span>
</span><span class='line'>  <span class="na">xsi:schemaLocation=</span><span class="s">&quot;</span>
</span><span class='line'><span class="s">    http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.1.xsd</span>
</span><span class='line'><span class="s">    http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.1.xsd&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c">&lt;!-- enable component scanning --&gt;</span>
</span><span class='line'>  <span class="nt">&lt;context:component-scan</span> <span class="na">base-package=</span><span class="s">&quot;net.burtsev.example&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c">&lt;!-- enable autowire --&gt;</span>
</span><span class='line'>  <span class="nt">&lt;context:annotation-config</span> <span class="nt">/&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;/beans&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Код</h2>

<p>Ну а теперь после того как все необходимые настройки сделаны - попробуем написать код:</p>

<h3>index.xhtml</h3>

<figure class='code'><figcaption><span>index.xhtml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;ui:composition</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.w3.org/1999/xhtml&quot;</span>
</span><span class='line'>  <span class="na">xmlns:h=</span><span class="s">&quot;http://java.sun.com/jsf/html&quot;</span>
</span><span class='line'>  <span class="na">xmlns:f=</span><span class="s">&quot;http://java.sun.com/jsf/core&quot;</span>
</span><span class='line'>  <span class="na">xmlns:ui=</span><span class="s">&quot;http://java.sun.com/jsf/facelets&quot;</span> <span class="na">template=</span><span class="s">&quot;/templates/main.xhtml&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;ui:define</span> <span class="na">name=</span><span class="s">&quot;title&quot;</span><span class="nt">&gt;</span>Home<span class="nt">&lt;/ui:define&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;ui:define</span> <span class="na">name=</span><span class="s">&quot;body&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;h:form</span> <span class="na">prependId=</span><span class="s">&quot;false&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>          <span class="nt">&lt;h:inputText</span> <span class="na">value=</span><span class="s">&quot;#{testBean.name}&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>          <span class="nt">&lt;h:commandButton</span> <span class="na">action=</span><span class="s">&quot;#{testBean.sayHelloAction}&quot;</span> <span class="na">value=</span><span class="s">&quot;Say Hello&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>          <span class="nt">&lt;br/&gt;</span>
</span><span class='line'>          #{testBean.hello}
</span><span class='line'>      <span class="nt">&lt;/h:form&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/ui:define&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;/ui:composition&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>TestBean.java</h3>

<p>Здесь нужно отметить использование аннотации @Controller вместо @ManagedBean и @Scope для указания времени жизни бина. Список всех возможных scope можно посмотреть тут: <a href="http://static.springsource.org/spring/docs/3.1.x/spring-framework-reference/html/beans.html#beans-factory-scopes">Spring Framework Reference</a>. Так же стоит отметить отсутствие view scope по дефолту. Но эту проблему можно обойти, например, как описано в <a href="http://comdynamics.net/blog/109/spring3-jsf2-view-scope/">этой статье</a> или <a href="http://cagataycivici.wordpress.com/2010/02/17/port-jsf-2-0s-viewscope-to-spring-3-0/">в этой</a></p>

<figure class='code'><figcaption><span>TestBean.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">net</span><span class="o">.</span><span class="na">burtsev</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">web</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.commons.lang3.StringUtils</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Scope</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@Controller</span>
</span><span class='line'><span class="nd">@Scope</span><span class="o">(</span><span class="s">&quot;session&quot;</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestBean</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">String</span> <span class="n">hello</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sayHelloAction</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">hello</span> <span class="o">=</span> <span class="n">StringUtils</span><span class="o">.</span><span class="na">isNotBlank</span><span class="o">(</span><span class="n">name</span><span class="o">)</span> <span class="o">?</span> <span class="s">&quot;Hello &quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">name</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setName</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="n">String</span> <span class="nf">getHello</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">hello</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setHello</span><span class="o">(</span><span class="n">String</span> <span class="n">hello</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">this</span><span class="o">.</span><span class="na">hello</span> <span class="o">=</span> <span class="n">hello</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Пример работы</h2>

<p>Запускаем, переходим по адресу: <a href="http://localhost:8080/jsf2-spring-example/index.jsf">http://localhost:8080/jsf2-spring-example/index.jsf</a> и видим что все работает :)</p>

<p><a href="http://burtsev.net/downloads/192/test1.png"><img src="http://burtsev.net/downloads/192/test1.png" width="500" height="180" title="'Example #1'" ></a>
<a href="http://burtsev.net/downloads/192/test2.png"><img src="http://burtsev.net/downloads/192/test2.png" width="500" height="180" title="'Example #2'" ></a></p>

<p>P.S. Полный проект можно взять здесь: <a href="https://github.com/eburtsev/jsf2-spring-example">github repository</a></p>
]]></content>
  </entry>
  
  
  
  
  
  <entry>
    <title type="html"><![CDATA[Google gdata maven repository]]></title>
    <link href="http://burtsev.net/2012/01/29/149/"/>
    <updated>2012-01-29T20:24:00+04:00</updated>
    <id>http://burtsev.net/2012/01/29/149</id>
    <content type="html"><![CDATA[<p>Недавно пришлось столкнуться с тем что для гугловской библиотеки <a href="http://code.google.com/p/gdata-java-client/">gdata</a> отсутствуют maven-репозитории. Конечно есть новая библиотека <a href="http://code.google.com/p/google-api-java-client/">google-api-java-client</a>, но в ней реализованы не все API, например недостает Provisioning API для доменов.</p>

<p>В поиске было найдено несколько репозиториев, но во всех из них лежат только старые версии библиотеки.</p>

<p>Так же был найден замечательный <a href="https://github.com/dcarter/Google-Data-APIs-Mavenized/network">скрипт</a> для создания локального maven-репозитория.</p>

<p>Поскольку не у всех есть время и возможность создать свой репозиторий (под Windows например у меня этот скрипт запустить так и не получилось), то я решил выложить результаты работы у себя на сервере - вдруг кому-то и сгодится.</p>

<p>Подробности под катом</p>

<!--more-->


<p>Как пользоваться:<br/>
Во-первых подключить репозиторий в вашем <code>pom.xml</code>, например как в примере ниже:</p>

<figure class='code'><figcaption><span>pom.xml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;repositories&gt;</span>
</span><span class='line'>  <span class="nt">&lt;repository&gt;</span>
</span><span class='line'>      <span class="nt">&lt;id&gt;</span>burtsev-net-maven<span class="nt">&lt;/id&gt;</span>
</span><span class='line'>      <span class="nt">&lt;name&gt;</span>Burtsev.Net Maven Repository<span class="nt">&lt;/name&gt;</span>
</span><span class='line'>      <span class="nt">&lt;url&gt;</span>http://maven.burtsev.net<span class="nt">&lt;/url&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/repository&gt;</span>
</span><span class='line'><span class="nt">&lt;/repositories&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>
Или можно воспользоваться зеркалом на github&#8217;e:</p>

<figure class='code'><figcaption><span>pom.xml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;repositories&gt;</span>
</span><span class='line'>  <span class="nt">&lt;repository&gt;</span>
</span><span class='line'>      <span class="nt">&lt;id&gt;</span>gdata-maven-github<span class="nt">&lt;/id&gt;</span>
</span><span class='line'>      <span class="nt">&lt;name&gt;</span>Google Gdata Maven Repository<span class="nt">&lt;/name&gt;</span>
</span><span class='line'>      <span class="nt">&lt;url&gt;</span>https://raw.github.com/eburtsev/gdata-maven/master/<span class="nt">&lt;/url&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/repository&gt;</span>
</span><span class='line'><span class="nt">&lt;/repositories&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>
И во-вторых подключить необходимые зависимости. Например подключим Calendar API версии 2.0:</p>

<figure class='code'><figcaption><span>pom.xml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;dependency&gt;</span>
</span><span class='line'>  <span class="nt">&lt;groupId&gt;</span>com.google.gdata.gdata-java-client<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>  <span class="nt">&lt;artifactId&gt;</span>gdata-calendar-2.0<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>  <span class="nt">&lt;version&gt;</span>1.46.0<span class="nt">&lt;/version&gt;</span>
</span><span class='line'><span class="nt">&lt;/dependency&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>
Собственно все :) Надеюсь кому то это пригодится :)</p>

<p>P.S. Модифицированную версию скрипта можно взять <a href="https://github.com/eburtsev/Google-Data-APIs-Mavenized">здесь</a></p>

<p><strong>Upd. 2012-04-24:</strong> Репозиторий обновлен, добавлены библиотеки версии v1.47.0<br/>
<strong>Upd. 2012-08-14:</strong> Репозиторий обновлен, добавлены библиотеки версии v1.47.1<br/>
<strong>Upd. 2012-12-23:</strong> В репозиторий добавлены исходники и javadoc&#8217;и</p>
]]></content>
  </entry>
  
  
  
  
  
  
  
  <entry>
    <title type="html"><![CDATA[Поддержка Java 7 try-with-resources в MyBatis]]></title>
    <link href="http://burtsev.net/2012/01/13/107/"/>
    <updated>2012-01-13T10:41:00+04:00</updated>
    <id>http://burtsev.net/2012/01/13/107</id>
    <content type="html"><![CDATA[<p>В Java 7 появился аналог конструкции using из C# - <a href="http://docs.oracle.com/javase/tutorial/essential/exceptions/tryResourceClose.html">try-with-resources</a>. Данную фишку очень хорошо использовать для автоматического закрытия ресурсов типа коннектов к базам данных и тд. Например так:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="k">try</span> <span class="o">(</span><span class="n">SqlSession</span> <span class="n">session</span> <span class="o">=</span> <span class="n">ConnectionFactory</span><span class="o">.</span><span class="na">getSqlSessionFactory</span><span class="o">().</span><span class="na">openSession</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>  <span class="c1">// Work with session</span>
</span><span class='line'>  <span class="n">session</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Но вот беда - класс org.apache.ibatis.session.SqlSession из MyBatis 3.0.6 использующегося в проекте не реализует интерфейс AutoCloseable необходимый для того что бы эта конструкция заработала. Надеюсь что в следующей версии поддержку добавят, а пока предлагаю небольшой workaround.</p>

<!--more-->


<p>В первую очередь реализуем обертку для класса SqlSession реализующую интерфейс AutoCloseable:</p>

<figure class='code'><figcaption><span>SqlSession.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">net</span><span class="o">.</span><span class="na">burtsev</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">dao</span><span class="o">.</span><span class="na">mybatis</span><span class="o">.</span><span class="na">session</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.io.Closeable</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.sql.Connection</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.ibatis.executor.BatchResult</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.ibatis.session.Configuration</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.ibatis.session.ResultHandler</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.ibatis.session.RowBounds</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&quot;rawtypes&quot;</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SqlSession</span> <span class="kd">implements</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">ibatis</span><span class="o">.</span><span class="na">session</span><span class="o">.</span><span class="na">SqlSession</span><span class="o">,</span> <span class="n">Closeable</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">private</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">ibatis</span><span class="o">.</span><span class="na">session</span><span class="o">.</span><span class="na">SqlSession</span> <span class="n">wrappedSession</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">SqlSession</span><span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">ibatis</span><span class="o">.</span><span class="na">session</span><span class="o">.</span><span class="na">SqlSession</span> <span class="n">wrappedSession</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">this</span><span class="o">.</span><span class="na">wrappedSession</span> <span class="o">=</span> <span class="n">wrappedSession</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">Object</span> <span class="nf">selectOne</span><span class="o">(</span><span class="n">String</span> <span class="n">statement</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">wrappedSession</span><span class="o">.</span><span class="na">selectOne</span><span class="o">(</span><span class="n">statement</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">Object</span> <span class="nf">selectOne</span><span class="o">(</span><span class="n">String</span> <span class="n">statement</span><span class="o">,</span> <span class="n">Object</span> <span class="n">parameter</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">wrappedSession</span><span class="o">.</span><span class="na">selectOne</span><span class="o">(</span><span class="n">statement</span><span class="o">,</span> <span class="n">parameter</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">List</span> <span class="nf">selectList</span><span class="o">(</span><span class="n">String</span> <span class="n">statement</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">wrappedSession</span><span class="o">.</span><span class="na">selectList</span><span class="o">(</span><span class="n">statement</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">List</span> <span class="nf">selectList</span><span class="o">(</span><span class="n">String</span> <span class="n">statement</span><span class="o">,</span> <span class="n">Object</span> <span class="n">parameter</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">wrappedSession</span><span class="o">.</span><span class="na">selectList</span><span class="o">(</span><span class="n">statement</span><span class="o">,</span> <span class="n">parameter</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">List</span> <span class="nf">selectList</span><span class="o">(</span><span class="n">String</span> <span class="n">statement</span><span class="o">,</span> <span class="n">Object</span> <span class="n">parameter</span><span class="o">,</span> <span class="n">RowBounds</span> <span class="n">rowBounds</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">wrappedSession</span><span class="o">.</span><span class="na">selectList</span><span class="o">(</span><span class="n">statement</span><span class="o">,</span> <span class="n">parameter</span><span class="o">,</span> <span class="n">rowBounds</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">Map</span> <span class="nf">selectMap</span><span class="o">(</span><span class="n">String</span> <span class="n">statement</span><span class="o">,</span> <span class="n">String</span> <span class="n">mapKey</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">wrappedSession</span><span class="o">.</span><span class="na">selectMap</span><span class="o">(</span><span class="n">statement</span><span class="o">,</span> <span class="n">mapKey</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">Map</span> <span class="nf">selectMap</span><span class="o">(</span><span class="n">String</span> <span class="n">statement</span><span class="o">,</span> <span class="n">Object</span> <span class="n">parameter</span><span class="o">,</span> <span class="n">String</span> <span class="n">mapKey</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">wrappedSession</span><span class="o">.</span><span class="na">selectMap</span><span class="o">(</span><span class="n">statement</span><span class="o">,</span> <span class="n">parameter</span><span class="o">,</span> <span class="n">mapKey</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">Map</span> <span class="nf">selectMap</span><span class="o">(</span><span class="n">String</span> <span class="n">statement</span><span class="o">,</span> <span class="n">Object</span> <span class="n">parameter</span><span class="o">,</span> <span class="n">String</span> <span class="n">mapKey</span><span class="o">,</span> <span class="n">RowBounds</span> <span class="n">rowBounds</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">wrappedSession</span><span class="o">.</span><span class="na">selectMap</span><span class="o">(</span><span class="n">statement</span><span class="o">,</span> <span class="n">parameter</span><span class="o">,</span> <span class="n">mapKey</span><span class="o">,</span> <span class="n">rowBounds</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">select</span><span class="o">(</span><span class="n">String</span> <span class="n">statement</span><span class="o">,</span> <span class="n">Object</span> <span class="n">parameter</span><span class="o">,</span> <span class="n">ResultHandler</span> <span class="n">handler</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">wrappedSession</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">statement</span><span class="o">,</span> <span class="n">parameter</span><span class="o">,</span> <span class="n">handler</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">select</span><span class="o">(</span><span class="n">String</span> <span class="n">statement</span><span class="o">,</span> <span class="n">ResultHandler</span> <span class="n">handler</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">wrappedSession</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">statement</span><span class="o">,</span> <span class="n">handler</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">select</span><span class="o">(</span><span class="n">String</span> <span class="n">statement</span><span class="o">,</span> <span class="n">Object</span> <span class="n">parameter</span><span class="o">,</span> <span class="n">RowBounds</span> <span class="n">rowBounds</span><span class="o">,</span> <span class="n">ResultHandler</span> <span class="n">handler</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">wrappedSession</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">statement</span><span class="o">,</span> <span class="n">parameter</span><span class="o">,</span> <span class="n">rowBounds</span><span class="o">,</span> <span class="n">handler</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">insert</span><span class="o">(</span><span class="n">String</span> <span class="n">statement</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">wrappedSession</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">statement</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">insert</span><span class="o">(</span><span class="n">String</span> <span class="n">statement</span><span class="o">,</span> <span class="n">Object</span> <span class="n">parameter</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">wrappedSession</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">statement</span><span class="o">,</span> <span class="n">parameter</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">update</span><span class="o">(</span><span class="n">String</span> <span class="n">statement</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">wrappedSession</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">statement</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">update</span><span class="o">(</span><span class="n">String</span> <span class="n">statement</span><span class="o">,</span> <span class="n">Object</span> <span class="n">parameter</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">wrappedSession</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">statement</span><span class="o">,</span> <span class="n">parameter</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">delete</span><span class="o">(</span><span class="n">String</span> <span class="n">statement</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">wrappedSession</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">statement</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">delete</span><span class="o">(</span><span class="n">String</span> <span class="n">statement</span><span class="o">,</span> <span class="n">Object</span> <span class="n">parameter</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">wrappedSession</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">statement</span><span class="o">,</span> <span class="n">parameter</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">commit</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">wrappedSession</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">commit</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">force</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">wrappedSession</span><span class="o">.</span><span class="na">commit</span><span class="o">(</span><span class="n">force</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">rollback</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">wrappedSession</span><span class="o">.</span><span class="na">rollback</span><span class="o">();</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">rollback</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">force</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">wrappedSession</span><span class="o">.</span><span class="na">rollback</span><span class="o">(</span><span class="n">force</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">BatchResult</span><span class="o">&gt;</span> <span class="n">flushStatements</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">wrappedSession</span><span class="o">.</span><span class="na">flushStatements</span><span class="o">();</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">close</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">wrappedSession</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">clearCache</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">wrappedSession</span><span class="o">.</span><span class="na">clearCache</span><span class="o">();</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">Configuration</span> <span class="nf">getConfiguration</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">wrappedSession</span><span class="o">.</span><span class="na">getConfiguration</span><span class="o">();</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="n">getMapper</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">wrappedSession</span><span class="o">.</span><span class="na">getMapper</span><span class="o">(</span><span class="n">type</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">Connection</span> <span class="nf">getConnection</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">wrappedSession</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Также нам понадобится обертка для SqlSessionFactory умеющая работать с нашим классом SqlSession.</p>

<figure class='code'><figcaption><span>SqlSessionFactory.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">net</span><span class="o">.</span><span class="na">burtsev</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">dao</span><span class="o">.</span><span class="na">mybatis</span><span class="o">.</span><span class="na">session</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.sql.Connection</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.ibatis.session.Configuration</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.ibatis.session.ExecutorType</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.ibatis.session.TransactionIsolationLevel</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SqlSessionFactory</span> <span class="kd">implements</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">ibatis</span><span class="o">.</span><span class="na">session</span><span class="o">.</span><span class="na">SqlSessionFactory</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">private</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">ibatis</span><span class="o">.</span><span class="na">session</span><span class="o">.</span><span class="na">SqlSessionFactory</span> <span class="n">wrappedFactory</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">SqlSessionFactory</span><span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">ibatis</span><span class="o">.</span><span class="na">session</span><span class="o">.</span><span class="na">SqlSessionFactory</span> <span class="n">wrappedFactory</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">this</span><span class="o">.</span><span class="na">wrappedFactory</span> <span class="o">=</span> <span class="n">wrappedFactory</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">SqlSession</span> <span class="nf">openSession</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="k">new</span> <span class="nf">SqlSession</span><span class="o">(</span><span class="n">wrappedFactory</span><span class="o">.</span><span class="na">openSession</span><span class="o">());</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">SqlSession</span> <span class="nf">openSession</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">autoCommit</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="k">new</span> <span class="nf">SqlSession</span><span class="o">(</span><span class="n">wrappedFactory</span><span class="o">.</span><span class="na">openSession</span><span class="o">(</span><span class="n">autoCommit</span><span class="o">));</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">SqlSession</span> <span class="nf">openSession</span><span class="o">(</span><span class="n">Connection</span> <span class="n">connection</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="k">new</span> <span class="nf">SqlSession</span><span class="o">(</span><span class="n">wrappedFactory</span><span class="o">.</span><span class="na">openSession</span><span class="o">(</span><span class="n">connection</span><span class="o">));</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">SqlSession</span> <span class="nf">openSession</span><span class="o">(</span><span class="n">TransactionIsolationLevel</span> <span class="n">level</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="k">new</span> <span class="nf">SqlSession</span><span class="o">(</span><span class="n">wrappedFactory</span><span class="o">.</span><span class="na">openSession</span><span class="o">(</span><span class="n">level</span><span class="o">));</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">SqlSession</span> <span class="nf">openSession</span><span class="o">(</span><span class="n">ExecutorType</span> <span class="n">execType</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="k">new</span> <span class="nf">SqlSession</span><span class="o">(</span><span class="n">wrappedFactory</span><span class="o">.</span><span class="na">openSession</span><span class="o">(</span><span class="n">execType</span><span class="o">));</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">SqlSession</span> <span class="nf">openSession</span><span class="o">(</span><span class="n">ExecutorType</span> <span class="n">execType</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">autoCommit</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="k">new</span> <span class="nf">SqlSession</span><span class="o">(</span><span class="n">wrappedFactory</span><span class="o">.</span><span class="na">openSession</span><span class="o">(</span><span class="n">execType</span><span class="o">,</span> <span class="n">autoCommit</span><span class="o">));</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">SqlSession</span> <span class="nf">openSession</span><span class="o">(</span><span class="n">ExecutorType</span> <span class="n">execType</span><span class="o">,</span> <span class="n">TransactionIsolationLevel</span> <span class="n">level</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="k">new</span> <span class="nf">SqlSession</span><span class="o">(</span><span class="n">wrappedFactory</span><span class="o">.</span><span class="na">openSession</span><span class="o">(</span><span class="n">execType</span><span class="o">,</span> <span class="n">level</span><span class="o">));</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">SqlSession</span> <span class="nf">openSession</span><span class="o">(</span><span class="n">ExecutorType</span> <span class="n">execType</span><span class="o">,</span> <span class="n">Connection</span> <span class="n">connection</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="k">new</span> <span class="nf">SqlSession</span><span class="o">(</span><span class="n">wrappedFactory</span><span class="o">.</span><span class="na">openSession</span><span class="o">(</span><span class="n">execType</span><span class="o">,</span> <span class="n">connection</span><span class="o">));</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">Configuration</span> <span class="nf">getConfiguration</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">wrappedFactory</span><span class="o">.</span><span class="na">getConfiguration</span><span class="o">();</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ну а теперь - магия: конфигурируем iBatis как обычно. Ну почти как обычно, за исключением строки 18, где мы инициализируем нашу обертку.</p>

<figure class='code'><figcaption><span>ConnectionFactory.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">net</span><span class="o">.</span><span class="na">burtsev</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">dao</span><span class="o">.</span><span class="na">mybatis</span><span class="o">.</span><span class="na">session</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.io.Reader</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.ibatis.io.Resources</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.ibatis.session.SqlSessionFactoryBuilder</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ConnectionFactory</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">private</span> <span class="kd">static</span> <span class="n">SqlSessionFactory</span> <span class="n">sqlSessionFactory</span><span class="o">;</span>
</span><span class='line'>  <span class="kd">private</span> <span class="kd">static</span> <span class="n">Reader</span> <span class="n">reader</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">static</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">reader</span> <span class="o">=</span> <span class="n">Resources</span><span class="o">.</span><span class="na">getResourceAsReader</span><span class="o">(</span><span class="s">&quot;mybatis-config.xml&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">if</span> <span class="o">(</span><span class="n">sqlSessionFactory</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>              <span class="n">sqlSessionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SqlSessionFactory</span><span class="o">(</span><span class="k">new</span> <span class="n">SqlSessionFactoryBuilder</span><span class="o">().</span><span class="na">build</span><span class="o">(</span><span class="n">reader</span><span class="o">,</span> <span class="n">Settings</span><span class="o">.</span><span class="na">getInstance</span><span class="o">()));</span>
</span><span class='line'>              <span class="n">sqlSessionFactory</span><span class="o">.</span><span class="na">getConfiguration</span><span class="o">().</span><span class="na">addMappers</span><span class="o">(</span><span class="s">&quot;net.burtsev.example.dao.mybatis.mappers&quot;</span><span class="o">);</span>
</span><span class='line'>          <span class="o">}</span>
</span><span class='line'>      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">private</span> <span class="nf">ConnectionFactory</span><span class="o">()</span> <span class="o">{</span> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="n">SqlSessionFactory</span> <span class="nf">getSqlSessionFactory</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">sqlSessionFactory</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Это все, теперь мы можем радоваться фишками java7 в проекте :)</p>
]]></content>
  </entry>
  
  
  
  <entry>
    <title type="html"><![CDATA[Обход исключения org.apache.ibatis.transaction. TransactionException в iBATIS при временной недоступности сервера баз данных]]></title>
    <link href="http://burtsev.net/2012/01/12/100/"/>
    <updated>2012-01-12T14:10:00+04:00</updated>
    <id>http://burtsev.net/2012/01/12/100</id>
    <content type="html"><![CDATA[<p>Иногда происходит неприятная ситуация когда сервер баз данных уходит в ребут.
В этом случае можно поймать неприятное исключение такого вида:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>Caused by: org.apache.ibatis.exceptions.PersistenceException:
</span><span class='line'>### Error opening session.  Cause: org.apache.ibatis.transaction.TransactionException: Error configuring AutoCommit.  Your driver may not support getAutoCommit() or setAutoCommit(). Requested setting: false.  Cause: com.mysql.jdbc.exceptions.jdbc4.CommunicationsException: The last packet successfully received from the server was 59,121,876 milliseconds ago.  The last packet sent successfully to the server was 59,121,984 milliseconds ago. is longer than the server configured value of &#39;wait_timeout&#39;. You should consider either expiring and/or testing connection validity before use in your application, increasing the server configured values for client timeouts, or using the Connector/J connection property &#39;autoReconnect=true&#39; to avoid this problem.
</span><span class='line'>### Cause: org.apache.ibatis.transaction.TransactionException: Error configuring AutoCommit.  Your driver may not support getAutoCommit() or setAutoCommit(). Requested setting: false.  Cause: com.mysql.jdbc.exceptions.jdbc4.CommunicationsException: The last packet successfully received from the server was 59,121,876 milliseconds ago.  The last packet sent successfully to the server was 59,121,984 milliseconds ago. is longer than the server configured value of &#39;wait_timeout&#39;. You should consider either expiring and/or testing connection validity before use in your application, increasing the server configured values for client timeouts, or using the Connector/J connection property &#39;autoReconnect=true&#39; to avoid this problem.
</span><span class='line'>        at org.apache.ibatis.exceptions.ExceptionFactory.wrapException(ExceptionFactory.java:8)
</span><span class='line'>        at org.apache.ibatis.session.defaults.DefaultSqlSessionFactory.openSessionFromDataSource(DefaultSqlSessionFactory.java:83)
</span><span class='line'>        at org.apache.ibatis.session.defaults.DefaultSqlSessionFactory.openSession(DefaultSqlSessionFactory.java:32)
</span><span class='line'>        at com.greytower.htmltemplates.core.dao.ibatis.TemplatesDAOImpl.readAll(TemplatesDAOImpl.java:70)
</span><span class='line'>        at com.greytower.htmltemplates.beans.TemplatesEditorBean.init(TemplatesEditorBean.java:86)
</span><span class='line'>        ... 59 more
</span><span class='line'>Caused by: org.apache.ibatis.transaction.TransactionException: Error configuring AutoCommit.  Your driver may not support getAutoCommit() or setAutoCommit(). Requested setting: false.  Cause: com.mysql.jdbc.exceptions.jdbc4.CommunicationsException: The last packet successfully received from the server was 59,121,876 milliseconds ago.  The last packet sent successfully to the server was 59,121,984 milliseconds ago. is longer than the server configured value of &#39;wait_timeout&#39;. You should consider either expiring and/or testing connection validity before use in your application, increasing the server configured values for client timeouts, or using the Connector/J connection property &#39;autoReconnect=true&#39; to avoid this problem.
</span><span class='line'>        at org.apache.ibatis.transaction.jdbc.JdbcTransaction.setDesiredAutoCommit(JdbcTransaction.java:51)
</span><span class='line'>        at org.apache.ibatis.transaction.jdbc.JdbcTransaction.&lt;init&gt;(JdbcTransaction.java:19)
</span><span class='line'>        at org.apache.ibatis.transaction.jdbc.JdbcTransactionFactory.newTransaction(JdbcTransactionFactory.java:15)
</span><span class='line'>        at org.apache.ibatis.session.defaults.DefaultSqlSessionFactory.openSessionFromDataSource(DefaultSqlSessionFactory.java:78)
</span><span class='line'>        ... 62 more
</span><span class='line'>Caused by: com.mysql.jdbc.exceptions.jdbc4.CommunicationsException: The last packet successfully received from the server was 59,121,876 milliseconds ago.  The last packet sent successfully to the server was 59,121,984 milliseconds ago. is longer than the server configured value of &#39;wait_timeout&#39;. You should consider either expiring and/or testing connection validity before use in your application, increasing the server configured values for client timeouts, or using the Connector/J connection property &#39;autoReconnect=true&#39; to avoid this problem.
</span></code></pre></td></tr></table></div></figure>


<!--more-->


<p>Для решения этой проблемы нужно установить свойства poolPingQuery и poolPingEnabled в конфиге iBatis. Например, как это сделано в примере ниже в строках 17 и 18.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
</span><span class='line'><span class="cp">&lt;!DOCTYPE configuration PUBLIC &quot;-//mybatis.org//DTD Config 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;&gt;</span>
</span><span class='line'><span class="nt">&lt;configuration&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;typeAliases&gt;</span>
</span><span class='line'>      ...
</span><span class='line'>  <span class="nt">&lt;/typeAliases&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;environments</span> <span class="na">default=</span><span class="s">&quot;development&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;environment</span> <span class="na">id=</span><span class="s">&quot;development&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>          <span class="nt">&lt;transactionManager</span> <span class="na">type=</span><span class="s">&quot;JDBC&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>          <span class="nt">&lt;dataSource</span> <span class="na">type=</span><span class="s">&quot;POOLED&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>              <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;driver&quot;</span> <span class="na">value=</span><span class="s">&quot;${db.driver}&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>              <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;url&quot;</span> <span class="na">value=</span><span class="s">&quot;${db.url}&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>              <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;username&quot;</span> <span class="na">value=</span><span class="s">&quot;${db.user}&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>              <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;password&quot;</span> <span class="na">value=</span><span class="s">&quot;${db.password}&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>              <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;poolPingQuery&quot;</span> <span class="na">value=</span><span class="s">&quot;SELECT id FROM user WHERE id = 1&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>              <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;poolPingEnabled&quot;</span> <span class="na">value=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>          <span class="nt">&lt;/dataSource&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/environment&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/environments&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;/configuration&gt;</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  
  
  
  
  <entry>
    <title type="html"><![CDATA[PrimeFaces tips & tricks]]></title>
    <link href="http://burtsev.net/2011/10/02/63/"/>
    <updated>2011-10-02T13:00:00+04:00</updated>
    <id>http://burtsev.net/2011/10/02/63</id>
    <content type="html"><![CDATA[<p>В данном посте я постараюсь описать решения типичных проблем возникающих при работе с прекрасной библиотекой JSF компонентов <a href="http://primefaces.org">PrimeFaces</a></p>

<!--more-->


<h2>Размер компонентов</h2>

<p>Наверное каждый кто начинал пользоваться библиотекой задавался вопросом &#8220;Почему компоненты выглядят такими огромными, хотя в демо они смотрятся гораздо приличнее?&#8221;. Для решения этой проблемы достаточно добавить внутри тега <code>&lt;h:head&gt;&lt;/h:head&gt;</code> следующий CSS код:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="nc">.ui-widget</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">font-size</span><span class="o">:</span> <span class="m">75</span><span class="o">%</span> <span class="cp">!important</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nc">.ui-widget</span> <span class="nc">.ui-widget</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">font-size</span><span class="o">:</span> <span class="m">100</span><span class="o">%</span> <span class="cp">!important</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>PrimeFaces и Internet Explorer</h2>

<p>При использовании данной библиотеки в IE могут возникать проблемы с рендерингом, для избавления от которых рекомендуется устанавливать заголовок X-UA-Compatible. В старых версиях библиотеки (до 3.0) это делалось установкой тега meta в начале <code>&lt;h:head&gt;&lt;/h:head&gt;</code>. Однако начиная с версии 3.0 библиотека сначала вставляет свой код в тег head, а уже следом за ним пользовательский. Для того что бы обойти эту проблему в третьей версии был определен facet &#8220;first&#8221;, содержимое которого вставляется в самое начало тега head:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;h:head&gt;</span>
</span><span class='line'>  <span class="nt">&lt;f:facet</span> <span class="na">name=</span><span class="s">&quot;first&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;X-UA-Compatible&quot;</span> <span class="na">content=</span><span class="s">&quot;EmulateIE8&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>      <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;Content-Type&quot;</span> <span class="na">content=</span><span class="s">&quot;text/xhtml; charset=UTF-8&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>      <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;Cache-Control&quot;</span> <span class="na">content=</span><span class="s">&quot;no-cache&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>      <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;Pragma&quot;</span> <span class="na">content=</span><span class="s">&quot;no-cache&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>      <span class="nt">&lt;title&gt;&lt;ui:insert</span> <span class="na">name=</span><span class="s">&quot;title&quot;</span><span class="nt">&gt;</span>Application Title<span class="nt">&lt;/ui:insert&gt;&lt;/title&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/f:facet&gt;</span>
</span><span class='line'><span class="nt">&lt;/h:head&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Вертикальные табы в p:tabView</h2>

<p>Поскольку компоненты библиотеки основаны на jQueryUI, то для создания вертикальных табов можно использовать решение из <a href="http://jquery-ui.googlecode.com/svn/trunk/demos/tabs/vertical.html">этого демо</a>. Во первых необходимо добавить CSS код:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="c">/* Vertical Tabs</span>
</span><span class='line'><span class="c">----------------------------------*/</span>
</span><span class='line'><span class="nc">.ui-tabs-vertical</span> <span class="p">{</span> <span class="k">width</span><span class="o">:</span> <span class="m">55em</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="nc">.ui-tabs-vertical</span> <span class="nc">.ui-tabs-nav</span> <span class="p">{</span> <span class="k">padding</span><span class="o">:</span> <span class="m">.2em</span> <span class="m">.1em</span> <span class="m">.2em</span> <span class="m">.2em</span><span class="p">;</span> <span class="k">float</span><span class="o">:</span> <span class="k">left</span><span class="p">;</span> <span class="k">width</span><span class="o">:</span> <span class="m">12em</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="nc">.ui-tabs-vertical</span> <span class="nc">.ui-tabs-nav</span> <span class="nt">li</span> <span class="p">{</span> <span class="k">clear</span><span class="o">:</span> <span class="k">left</span><span class="p">;</span> <span class="k">width</span><span class="o">:</span> <span class="m">100</span><span class="o">%</span><span class="p">;</span> <span class="k">border-bottom-width</span><span class="o">:</span> <span class="m">1px</span> <span class="cp">!important</span><span class="p">;</span> <span class="k">border-right</span><span class="o">-</span><span class="k">width</span><span class="o">:</span> <span class="m">0</span> <span class="cp">!important</span><span class="p">;</span> <span class="k">margin</span><span class="o">:</span> <span class="m">0</span> <span class="m">-1px</span> <span class="m">.2em</span> <span class="m">0</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="nc">.ui-tabs-vertical</span> <span class="nc">.ui-tabs-nav</span> <span class="nt">li</span> <span class="nt">a</span> <span class="p">{</span> <span class="k">display</span><span class="o">:</span><span class="k">block</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="nc">.ui-tabs-vertical</span> <span class="nc">.ui-tabs-nav</span> <span class="nt">li</span><span class="nc">.ui-tabs-selected</span> <span class="p">{</span> <span class="k">padding-bottom</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span> <span class="k">padding-right</span><span class="o">:</span> <span class="m">.1em</span><span class="p">;</span> <span class="k">border-right</span><span class="o">-</span><span class="k">width</span><span class="o">:</span> <span class="m">1px</span><span class="p">;</span> <span class="k">border-right</span><span class="o">-</span><span class="k">width</span><span class="o">:</span> <span class="m">1px</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="nc">.ui-tabs-vertical</span> <span class="nc">.ui-tabs-panel</span> <span class="p">{</span> <span class="k">padding</span><span class="o">:</span> <span class="m">1em</span><span class="p">;</span> <span class="k">float</span><span class="o">:</span> <span class="k">right</span><span class="p">;</span> <span class="k">width</span><span class="o">:</span> <span class="m">40em</span><span class="p">;}</span>
</span></code></pre></td></tr></table></div></figure>


<p>А во вторых подключить класс к нужному tabView</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;p:tabView</span> <span class="na">styleClass=</span><span class="s">&quot;ui-tabs-vertical&quot;</span> <span class="nt">/&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Данное решение было найдено по мотивам данных вопросов на <a href="http://stackowerflow.com">StackOverflow</a>:
*   <a href="http://stackoverflow.com/q/6098319/600313">Make tabs appear vertically on the side when using PrimeFaces TabView</a>
*   <a href="http://stackoverflow.com/q/773074/600313">Vertical Tabs with JQuery?</a></p>

<p>Пока что это все :) При появлении еще каких нибудь заметок, обязуюсь выложить их на всеобщее обозрение.</p>
]]></content>
  </entry>
  
  
  
  
  
  <entry>
    <title type="html"><![CDATA[Установка связки Mercurial + UWSGI + Nginx + HTTPS на Ubuntu Server 10.04]]></title>
    <link href="http://burtsev.net/2011/08/03/13/"/>
    <updated>2011-08-03T20:28:00+04:00</updated>
    <id>http://burtsev.net/2011/08/03/13</id>
    <content type="html"><![CDATA[<p>Недавно появилась необходимость установить Mercurial сервер, используя в качестве фронтэнда nginx. В интернете довольно много информации на данную тему, но пришлось довольно много импровизировать что бы добиться результата. Итак, ниже представлен результат труда по настройке этой связки.</p>

<!--more-->


<p>Все нижеописанные действия производятся из под рута. Итак, приступим :)</p>

<h2>Установка необходимого софта</h2>

<h3>Python</h3>

<p>В первую очередь поставим Python.</p>

<pre><code>apt-get install python
</code></pre>

<p>Так же для удобства добавления сторонних PPA можно поставить python-software-properties:</p>

<pre><code>apt-get install python-software-properties
</code></pre>

<p>После этого PPA можно добавлять командой</p>

<pre><code>add-apt-repository ppa:xxx/yyy
</code></pre>

<h3>Mercurial</h3>

<p>Поскольку в репозитории Lucid Lynx находится версия mercurial&#8217;а, древняя как говно мамона, то подключаем PPA с новыми версиями:</p>

<pre><code>add-apt-repository ppa:mercurial-ppa/stable-snapshots
apt-get update
apt-get install mercurial
</code></pre>

<h3>Nginx</h3>

<p>В основном репозитории nginx отсутствует поэтому подключаем PPA и устанавливаем.</p>

<pre><code>add-apt-repository ppa:nginx/stable
apt-get update
apt-get install nginx
</code></pre>

<h3>uwsgi-python</h3>

<p>В качестве сервера python-приложений установим uwsgi-python.</p>

<pre><code>add-apt-repository ppa:uwsgi/release
apt-get update
apt-get install uwsgi-python
</code></pre>

<h2>Настройка</h2>

<p>Теперь после установки софта начинается самое сложное - настройка.
Во первых, рассмотрим структуру директорий, которая будет использоваться.</p>

<pre><code>/var/www/hosts/hg.server.net/conf    здесь будут расположены конфиги
/var/www/hosts/hg.server.net/logs    директория для логов
/var/www/hosts/hg.server.net/repos   директория, содержащая репозитории
</code></pre>

<h3>Mercurial + uwsgi</h3>

<p>Создадим файл описания UWSGI-приложения <code>/etc/uwsgi-python/apps-available/hgweb.xml</code> примерно такого содержания:</p>

<figure class='code'><figcaption><span>hgweb.xml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;uwsgi&gt;</span>
</span><span class='line'>  <span class="nt">&lt;socket&gt;</span>/var/run/uwsgi.hgweb.sock<span class="nt">&lt;/socket&gt;</span>
</span><span class='line'>  <span class="nt">&lt;master/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;workers&gt;</span>2<span class="nt">&lt;/workers&gt;</span>
</span><span class='line'>  <span class="cp">&lt;![CDATA[</span>
</span><span class='line'><span class="cp">     import uwsgi</span>
</span><span class='line'><span class="cp">     import os</span>
</span><span class='line'>
</span><span class='line'><span class="cp">     os.environ[&quot;HGENCODING&quot;] = &quot;UTF-8&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">     from mercurial import demandimport; demandimport.enable()</span>
</span><span class='line'><span class="cp">     from mercurial.hgweb.hgwebdir_mod import hgwebdir</span>
</span><span class='line'>
</span><span class='line'><span class="cp">     application = hgwebdir(&#39;/var/www/hosts/hg.server.net/conf/hgweb.config&#39;)</span>
</span><span class='line'><span class="cp"> ]]&gt;</span>
</span><span class='line'><span class="nt">&lt;/uwsgi&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Параметр socket задает адрес который будет прослушивать сервер. workers количество запущенных воркеров. Обратите внимание что в 14-ой строке необходимо указать правильный путь к конфигу hgweb, созданием которого мы сейчас и займемся.</p>

<p>Для этого создаем файл <code>/var/www/hosts/hg.server.net/conf/hgweb.config</code>:</p>

<figure class='code'><figcaption><span>hgweb.config</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ini'><span class='line'><span class="k">[web]</span>
</span><span class='line'><span class="na">push_ssl</span> <span class="o">=</span> <span class="s">true</span>
</span><span class='line'><span class="na">allow_push</span> <span class="o">=</span> <span class="s">*</span>
</span><span class='line'><span class="na">style</span> <span class="o">=</span> <span class="s">gitweb</span>
</span><span class='line'><span class="na">allow_archive</span> <span class="o">=</span> <span class="s">gz, zip, bz2</span>
</span><span class='line'>
</span><span class='line'><span class="k">[collections]</span>
</span><span class='line'><span class="na">/var/www/hosts/hg.server.net/repos/</span> <span class="o">=</span> <span class="s">/var/www/hosts/hg.server.net/repos/</span>
</span></code></pre></td></tr></table></div></figure>


<p>Во второй строке мы разрешаем проталкивать изменения только по SSL.
В третьей можно перечислить через запятую пользователей которым разрешено проталкивать изменения на сервер.
В четвертой выбирается стиль интерфейса. Мне больше всего нравится gitweb.
в последней строке необходимо установить корректные пути до репозиториев.
Теперь, для проверки корректности настроек временно поменяем строку <code>&lt;socket&gt;/var/run/uwsgi.hgweb.sock&lt;/socket&gt;</code> в файле hgweb.xml на <code>&lt;socket&gt;127.0.0.1:3031&lt;/socket&gt;</code> и запустим следующую команду:</p>

<pre><code>uwsgi-python -x /etc/uwsgi-python/apps-available/hgweb.xml
</code></pre>

<p>Если все настроено верно то никаких ошибок выведено не будет. И если зайти браузером по адресу <code>http://127.0.0.1:3031/</code> то отобразится список репозиториев. Если все нормально то меняем файл hgweb.xml обратно и создаем симлинк в <code>/etc/uwsgi-python/apps-enabled</code>:</p>

<pre><code>ln -s /etc/uwsgi-python/apps-{available,enabled}/hgweb.xml
</code></pre>

<p>Теперь можно переходить к следующему этапу.</p>

<h3>Nginx</h3>

<p>Создадим файл паролей при помощи утилиты htpasswd</p>

<pre><code>htpasswd -c /var/www/auth/.htpasswd &lt;username&gt;
</code></pre>

<p>Создаем конфиг /etc/nginx/sites-available/hg.server.net</p>

<figure class='code'><figcaption><span>hg.server.net</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class='nginx'><span class='line'><span class="k">server</span> <span class="p">{</span>
</span><span class='line'>  <span class="kn">listen</span>               <span class="mi">443</span><span class="p">;</span>
</span><span class='line'>  <span class="kn">listen</span>               <span class="mi">80</span><span class="p">;</span>
</span><span class='line'>  <span class="kn">server_name</span>          <span class="s">hg.server.net</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kn">ssl</span>                  <span class="no">on</span><span class="p">;</span>
</span><span class='line'>  <span class="kn">ssl_protocols</span>        <span class="s">SSLv3</span> <span class="s">TLSv1</span><span class="p">;</span>
</span><span class='line'>  <span class="kn">ssl_certificate</span>      <span class="s">/var/www/hosts/hg.server.net/ssl/ssl_certificate.crt</span><span class="p">;</span>
</span><span class='line'>  <span class="kn">ssl_certificate_key</span>  <span class="s">/var/www/hosts/hg.server.net/ssl/ssl_certificate.key</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kn">root</span>                 <span class="s">/var/www/hosts/hg.server.net/www</span><span class="p">;</span>
</span><span class='line'>  <span class="kn">access_log</span>           <span class="s">/var/www/hosts/hg.server.net/logs/access.log</span><span class="p">;</span>
</span><span class='line'>  <span class="kn">error_log</span>            <span class="s">/var/www/hosts/hg.server.net/logs/error.log</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Need for very big files</span>
</span><span class='line'>  <span class="kn">client_max_body_size</span> <span class="mi">100m</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kn">if</span> <span class="s">(</span> <span class="nv">$scheme</span> <span class="p">=</span> <span class="s">&quot;http&quot;</span> <span class="s">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kn">rewrite</span> <span class="s">^/(.*)</span>$  <span class="s">https://</span><span class="nv">$host/$1</span> <span class="s">permanent</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
</span><span class='line'>      <span class="kn">auth_basic</span>                  <span class="s">&quot;Mercurial</span> <span class="s">Repository&quot;</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">auth_basic_user_file</span>        <span class="s">/var/www/auth/.htpasswd</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">include</span>     <span class="s">uwsgi_params</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">uwsgi_param</span> <span class="s">REMOTE_PORT</span>     <span class="nv">$remote_port</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">uwsgi_param</span> <span class="s">SERVER_PORT</span>     <span class="nv">$server_port</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">uwsgi_param</span> <span class="s">SERVER_PROTOCOL</span> <span class="nv">$server_protocol</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">uwsgi_param</span> <span class="s">UWSGI_SCHEME</span>    <span class="nv">$scheme</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">uwsgi_param</span> <span class="s">SCRIPT_NAME</span>     <span class="s">/</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">uwsgi_param</span> <span class="s">AUTH_USER</span>       <span class="nv">$remote_user</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">uwsgi_param</span> <span class="s">REMOTE_USER</span>     <span class="nv">$remote_user</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">uwsgi_pass</span>  <span class="s">hgweb</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kn">location</span> <span class="s">/static/</span> <span class="p">{</span>
</span><span class='line'>      <span class="kn">rewrite</span>       <span class="s">/static/(.*)</span>  <span class="s">/</span><span class="nv">$1</span> <span class="s">break</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">root</span>          <span class="s">/usr/share/mercurial/templates/static</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">expires</span> <span class="s">30d</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kn">location</span> <span class="p">~</span> <span class="sr">/\.</span> <span class="p">{</span>
</span><span class='line'>      <span class="kn">deny</span> <span class="s">all</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">upstream</span> <span class="s">hgweb</span> <span class="p">{</span>
</span><span class='line'>  <span class="kn">server</span> <span class="s">unix:/var/run/uwsgi.hgweb.sock</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Делаем симлинк для нашего конфига в <code>/etc/nginx/sites-enabled</code>:</p>

<pre><code>ln -s /etc/nginx/sites-{available,enabled}/hg.server.net
</code></pre>

<p>Запускаем сервисы</p>

<pre><code>service uwsgi-python start
service nginx start
</code></pre>

<p>Если все хорошо то зайдя по адресу <code>http://hg.server.net/</code> увидим список репозиториев.
Если это так то сделаем что бы все запускалось автоматически при старте системы и забудем о настройке.</p>

<h3>Автоматический запуск сервисов при загрузке</h3>

<p>Во первых убедитесь что сделали симлинки на конфиги.
Во вторых следует настроить сервисы для автоматического запуска:</p>

<pre><code>update-rc.d uwsgi-python defaults
update-rc.d nginx defaults
</code></pre>

<p>Все - настройка завершена, можно перезагрузиться и еще раз проверить работу.</p>
]]></content>
  </entry>
  
  
  
  
</feed>
