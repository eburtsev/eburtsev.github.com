<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Eugene Burtsev's blog]]></title>
  <link href="http://eburtsev.github.com/atom.xml" rel="self"/>
  <link href="http://eburtsev.github.com/"/>
  <updated>2012-12-01T00:39:36+04:00</updated>
  <id>http://eburtsev.github.com/</id>
  <author>
    <name><![CDATA[Eugene Burtsev]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  
  <entry>
    <title type="html"><![CDATA[Поддержка Java 7 try-with-resources в MyBatis]]></title>
    <link href="http://eburtsev.github.com/2012/01/13/107/"/>
    <updated>2012-01-13T10:41:00+04:00</updated>
    <id>http://eburtsev.github.com/2012/01/13/107</id>
    <content type="html"><![CDATA[<p>В Java 7 появился аналог конструкции using из C# - <a href="http://docs.oracle.com/javase/tutorial/essential/exceptions/tryResourceClose.html">try-with-resources</a>. Данную фишку очень хорошо использовать для автоматического закрытия ресурсов типа коннектов к базам данных и тд. Например так:</p>

<div><script src='https://gist.github.com/1638790.js?file='></script>
<noscript><pre><code>try (SqlSession session = ConnectionFactory.getSqlSessionFactory().openSession()) {
    // Work with session
    session.commit();
}</code></pre></noscript></div>


<p>Но вот беда - класс org.apache.ibatis.session.SqlSession из MyBatis 3.0.6 использующегося в проекте не реализует интерфейс AutoCloseable необходимый для того что бы эта конструкция заработала. Надеюсь что в следующей версии поддержку добавят, а пока предлагаю небольшой workaround.</p>

<!--more-->


<p>В первую очередь реализуем обертку для класса SqlSession реализующую интерфейс AutoCloseable:</p>

<div><script src='https://gist.github.com/1638811.js?file='></script>
<noscript><pre><code>package net.burtsev.example.dao.mybatis.session;

import java.io.Closeable;
import java.sql.Connection;
import java.util.List;
import java.util.Map;

import org.apache.ibatis.executor.BatchResult;
import org.apache.ibatis.session.Configuration;
import org.apache.ibatis.session.ResultHandler;
import org.apache.ibatis.session.RowBounds;

@SuppressWarnings(&quot;rawtypes&quot;)
public class SqlSession implements org.apache.ibatis.session.SqlSession, Closeable {

    private org.apache.ibatis.session.SqlSession wrappedSession;

    SqlSession(org.apache.ibatis.session.SqlSession wrappedSession) {
        this.wrappedSession = wrappedSession;
    }

    @Override
    public Object selectOne(String statement) {
        return wrappedSession.selectOne(statement);
    }

    @Override
    public Object selectOne(String statement, Object parameter) {
        return wrappedSession.selectOne(statement, parameter);
    }

    @Override
    public List selectList(String statement) {
        return wrappedSession.selectList(statement);
    }

    @Override
    public List selectList(String statement, Object parameter) {
        return wrappedSession.selectList(statement, parameter);
    }

    @Override
    public List selectList(String statement, Object parameter, RowBounds rowBounds) {
        return wrappedSession.selectList(statement, parameter, rowBounds);
    }

    @Override
    public Map selectMap(String statement, String mapKey) {
        return wrappedSession.selectMap(statement, mapKey);
    }

    @Override
    public Map selectMap(String statement, Object parameter, String mapKey) {
        return wrappedSession.selectMap(statement, parameter, mapKey);
    }

    @Override
    public Map selectMap(String statement, Object parameter, String mapKey, RowBounds rowBounds) {
        return wrappedSession.selectMap(statement, parameter, mapKey, rowBounds);
    }

    @Override
    public void select(String statement, Object parameter, ResultHandler handler) {
        wrappedSession.select(statement, parameter, handler);
    }

    @Override
    public void select(String statement, ResultHandler handler) {
        wrappedSession.select(statement, handler);
    }

    @Override
    public void select(String statement, Object parameter, RowBounds rowBounds, ResultHandler handler) {
        wrappedSession.select(statement, parameter, rowBounds, handler);
    }

    @Override
    public int insert(String statement) {
        return wrappedSession.insert(statement);
    }

    @Override
    public int insert(String statement, Object parameter) {
        return wrappedSession.insert(statement, parameter);
    }

    @Override
    public int update(String statement) {
        return wrappedSession.update(statement);
    }

    @Override
    public int update(String statement, Object parameter) {
        return wrappedSession.update(statement, parameter);
    }

    @Override
    public int delete(String statement) {
        return wrappedSession.delete(statement);
    }

    @Override
    public int delete(String statement, Object parameter) {
        return wrappedSession.delete(statement, parameter);
    }

    @Override
    public void commit() {
        wrappedSession.commit();
    }

    @Override
    public void commit(boolean force) {
        wrappedSession.commit(force);
    }

    @Override
    public void rollback() {
        wrappedSession.rollback();
    }

    @Override
    public void rollback(boolean force) {
        wrappedSession.rollback(force);
    }

    @Override
    public List&lt;BatchResult&gt; flushStatements() {
        return wrappedSession.flushStatements();
    }

    @Override
    public void close() {
        wrappedSession.close();
    }

    @Override
    public void clearCache() {
        wrappedSession.clearCache();
    }

    @Override
    public Configuration getConfiguration() {
        return wrappedSession.getConfiguration();
    }

    @Override
    public &lt;T&gt; T getMapper(Class&lt;T&gt; type) {
        return wrappedSession.getMapper(type);
    }

    @Override
    public Connection getConnection() {
        return wrappedSession.getConnection();
    }

}</code></pre></noscript></div>


<p>Также нам понадобится обертка для SqlSessionFactory умеющая работать с нашим классом SqlSession.</p>

<div><script src='https://gist.github.com/1638826.js?file='></script>
<noscript><pre><code>package net.burtsev.example.dao.mybatis.session;

import java.sql.Connection;

import org.apache.ibatis.session.Configuration;
import org.apache.ibatis.session.ExecutorType;
import org.apache.ibatis.session.TransactionIsolationLevel;

public class SqlSessionFactory implements org.apache.ibatis.session.SqlSessionFactory {

    private org.apache.ibatis.session.SqlSessionFactory wrappedFactory;

    SqlSessionFactory(org.apache.ibatis.session.SqlSessionFactory wrappedFactory) {
        this.wrappedFactory = wrappedFactory;
    }

    @Override
    public SqlSession openSession() {
        return new SqlSession(wrappedFactory.openSession());
    }

    @Override
    public SqlSession openSession(boolean autoCommit) {
        return new SqlSession(wrappedFactory.openSession(autoCommit));
    }

    @Override
    public SqlSession openSession(Connection connection) {
        return new SqlSession(wrappedFactory.openSession(connection));
    }

    @Override
    public SqlSession openSession(TransactionIsolationLevel level) {
        return new SqlSession(wrappedFactory.openSession(level));
    }

    @Override
    public SqlSession openSession(ExecutorType execType) {
        return new SqlSession(wrappedFactory.openSession(execType));
    }

    @Override
    public SqlSession openSession(ExecutorType execType, boolean autoCommit) {
        return new SqlSession(wrappedFactory.openSession(execType, autoCommit));
    }

    @Override
    public SqlSession openSession(ExecutorType execType, TransactionIsolationLevel level) {
        return new SqlSession(wrappedFactory.openSession(execType, level));
    }

    @Override
    public SqlSession openSession(ExecutorType execType, Connection connection) {
        return new SqlSession(wrappedFactory.openSession(execType, connection));
    }

    @Override
    public Configuration getConfiguration() {
        return wrappedFactory.getConfiguration();
    }

}</code></pre></noscript></div>


<p>Ну а теперь - магия: конфигурируем iBatis как обычно. Ну почти как обычно, за исключением строки 18, где мы инициализируем нашу обертку.</p>

<div><script src='https://gist.github.com/1638837.js?file='></script>
<noscript><pre><code>package net.burtsev.example.dao.mybatis.session;

import java.io.Reader;

import org.apache.ibatis.io.Resources;
import org.apache.ibatis.session.SqlSessionFactoryBuilder;

public final class ConnectionFactory {

    private static SqlSessionFactory sqlSessionFactory;
    private static Reader reader;

    static {
        try {
            reader = Resources.getResourceAsReader(&quot;mybatis-config.xml&quot;);

            if (sqlSessionFactory == null) {
                sqlSessionFactory = new SqlSessionFactory(new SqlSessionFactoryBuilder().build(reader, Settings.getInstance()));
                sqlSessionFactory.getConfiguration().addMappers(&quot;net.burtsev.example.dao.mybatis.mappers&quot;);
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    private ConnectionFactory() { }

    public static SqlSessionFactory getSqlSessionFactory() {
        return sqlSessionFactory;
    }
}</code></pre></noscript></div>


<p>Это все, теперь мы можем радоваться фишками java7 в проекте :)</p>
]]></content>
  </entry>
  
  
  
  
  
  <entry>
    <title type="html"><![CDATA[Обход исключения org.apache.ibatis.transaction. TransactionException в iBATIS при временной недоступности сервера баз данных]]></title>
    <link href="http://eburtsev.github.com/2012/01/12/100/"/>
    <updated>2012-01-12T14:10:00+04:00</updated>
    <id>http://eburtsev.github.com/2012/01/12/100</id>
    <content type="html"><![CDATA[<p>Иногда происходит неприятная ситуация когда сервер баз данных уходит в ребут.
В этом случае можно поймать неприятное исключение такого вида:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>Caused by: org.apache.ibatis.exceptions.PersistenceException:
</span><span class='line'>### Error opening session.  Cause: org.apache.ibatis.transaction.TransactionException: Error configuring AutoCommit.  Your driver may not support getAutoCommit() or setAutoCommit(). Requested setting: false.  Cause: com.mysql.jdbc.exceptions.jdbc4.CommunicationsException: The last packet successfully received from the server was 59,121,876 milliseconds ago.  The last packet sent successfully to the server was 59,121,984 milliseconds ago. is longer than the server configured value of &#39;wait_timeout&#39;. You should consider either expiring and/or testing connection validity before use in your application, increasing the server configured values for client timeouts, or using the Connector/J connection property &#39;autoReconnect=true&#39; to avoid this problem.
</span><span class='line'>### Cause: org.apache.ibatis.transaction.TransactionException: Error configuring AutoCommit.  Your driver may not support getAutoCommit() or setAutoCommit(). Requested setting: false.  Cause: com.mysql.jdbc.exceptions.jdbc4.CommunicationsException: The last packet successfully received from the server was 59,121,876 milliseconds ago.  The last packet sent successfully to the server was 59,121,984 milliseconds ago. is longer than the server configured value of &#39;wait_timeout&#39;. You should consider either expiring and/or testing connection validity before use in your application, increasing the server configured values for client timeouts, or using the Connector/J connection property &#39;autoReconnect=true&#39; to avoid this problem.
</span><span class='line'>        at org.apache.ibatis.exceptions.ExceptionFactory.wrapException(ExceptionFactory.java:8)
</span><span class='line'>        at org.apache.ibatis.session.defaults.DefaultSqlSessionFactory.openSessionFromDataSource(DefaultSqlSessionFactory.java:83)
</span><span class='line'>        at org.apache.ibatis.session.defaults.DefaultSqlSessionFactory.openSession(DefaultSqlSessionFactory.java:32)
</span><span class='line'>        at com.greytower.htmltemplates.core.dao.ibatis.TemplatesDAOImpl.readAll(TemplatesDAOImpl.java:70)
</span><span class='line'>        at com.greytower.htmltemplates.beans.TemplatesEditorBean.init(TemplatesEditorBean.java:86)
</span><span class='line'>        ... 59 more
</span><span class='line'>Caused by: org.apache.ibatis.transaction.TransactionException: Error configuring AutoCommit.  Your driver may not support getAutoCommit() or setAutoCommit(). Requested setting: false.  Cause: com.mysql.jdbc.exceptions.jdbc4.CommunicationsException: The last packet successfully received from the server was 59,121,876 milliseconds ago.  The last packet sent successfully to the server was 59,121,984 milliseconds ago. is longer than the server configured value of &#39;wait_timeout&#39;. You should consider either expiring and/or testing connection validity before use in your application, increasing the server configured values for client timeouts, or using the Connector/J connection property &#39;autoReconnect=true&#39; to avoid this problem.
</span><span class='line'>        at org.apache.ibatis.transaction.jdbc.JdbcTransaction.setDesiredAutoCommit(JdbcTransaction.java:51)
</span><span class='line'>        at org.apache.ibatis.transaction.jdbc.JdbcTransaction.&lt;init&gt;(JdbcTransaction.java:19)
</span><span class='line'>        at org.apache.ibatis.transaction.jdbc.JdbcTransactionFactory.newTransaction(JdbcTransactionFactory.java:15)
</span><span class='line'>        at org.apache.ibatis.session.defaults.DefaultSqlSessionFactory.openSessionFromDataSource(DefaultSqlSessionFactory.java:78)
</span><span class='line'>        ... 62 more
</span><span class='line'>Caused by: com.mysql.jdbc.exceptions.jdbc4.CommunicationsException: The last packet successfully received from the server was 59,121,876 milliseconds ago.  The last packet sent successfully to the server was 59,121,984 milliseconds ago. is longer than the server configured value of &#39;wait_timeout&#39;. You should consider either expiring and/or testing connection validity before use in your application, increasing the server configured values for client timeouts, or using the Connector/J connection property &#39;autoReconnect=true&#39; to avoid this problem.
</span></code></pre></td></tr></table></div></figure>


<!--more-->


<p>Для решения этой проблемы нужно установить свойства poolPingQuery и poolPingEnabled в конфиге iBatis. Например, как это сделано в примере ниже в строках 17 и 18.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
</span><span class='line'><span class="cp">&lt;!DOCTYPE configuration PUBLIC &quot;-//mybatis.org//DTD Config 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;&gt;</span>
</span><span class='line'><span class="nt">&lt;configuration&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;typeAliases&gt;</span>
</span><span class='line'>      ...
</span><span class='line'>  <span class="nt">&lt;/typeAliases&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;environments</span> <span class="na">default=</span><span class="s">&quot;development&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;environment</span> <span class="na">id=</span><span class="s">&quot;development&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>          <span class="nt">&lt;transactionManager</span> <span class="na">type=</span><span class="s">&quot;JDBC&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>          <span class="nt">&lt;dataSource</span> <span class="na">type=</span><span class="s">&quot;POOLED&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>              <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;driver&quot;</span> <span class="na">value=</span><span class="s">&quot;${db.driver}&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>              <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;url&quot;</span> <span class="na">value=</span><span class="s">&quot;${db.url}&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>              <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;username&quot;</span> <span class="na">value=</span><span class="s">&quot;${db.user}&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>              <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;password&quot;</span> <span class="na">value=</span><span class="s">&quot;${db.password}&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>              <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;poolPingQuery&quot;</span> <span class="na">value=</span><span class="s">&quot;SELECT id FROM user WHERE id = 1&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>              <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;poolPingEnabled&quot;</span> <span class="na">value=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>          <span class="nt">&lt;/dataSource&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/environment&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/environments&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;/configuration&gt;</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  
  
  
  
  <entry>
    <title type="html"><![CDATA[PrimeFaces tips & tricks]]></title>
    <link href="http://eburtsev.github.com/2011/10/02/63/"/>
    <updated>2011-10-02T13:00:00+04:00</updated>
    <id>http://eburtsev.github.com/2011/10/02/63</id>
    <content type="html"><![CDATA[<p>В данном посте я постараюсь описать решения типичных проблем возникающих при работе с прекрасной библиотекой JSF компонентов <a href="http://primefaces.org">PrimeFaces</a></p>

<!--more-->


<h2>Размер компонентов</h2>

<p>Наверное каждый кто начинал пользоваться библиотекой задавался вопросом &#8220;Почему компоненты выглядят такими огромными, хотя в демо они смотрятся гораздо приличнее?&#8221;. Для решения этой проблемы достаточно добавить внутри тега <code>&lt;h:head&gt;&lt;/h:head&gt;</code> следующий CSS код:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="nc">.ui-widget</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">font-size</span><span class="o">:</span> <span class="m">75</span><span class="o">%</span> <span class="cp">!important</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nc">.ui-widget</span> <span class="nc">.ui-widget</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">font-size</span><span class="o">:</span> <span class="m">100</span><span class="o">%</span> <span class="cp">!important</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>PrimeFaces и Internet Explorer</h2>

<p>При использовании данной библиотеки в IE могут возникать проблемы с рендерингом, для избавления от которых рекомендуется устанавливать заголовок X-UA-Compatible. В старых версиях библиотеки (до 3.0) это делалось установкой тега meta в начале <code>&lt;h:head&gt;&lt;/h:head&gt;</code>. Однако начиная с версии 3.0 библиотека сначала вставляет свой код в тег head, а уже следом за ним пользовательский. Для того что бы обойти эту проблему в третьей версии был определен facet &#8220;first&#8221;, содержимое которого вставляется в самое начало тега head:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;h:head&gt;</span>
</span><span class='line'>  <span class="nt">&lt;f:facet</span> <span class="na">name=</span><span class="s">&quot;first&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;X-UA-Compatible&quot;</span> <span class="na">content=</span><span class="s">&quot;EmulateIE8&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>      <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;Content-Type&quot;</span> <span class="na">content=</span><span class="s">&quot;text/xhtml; charset=UTF-8&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>      <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;Cache-Control&quot;</span> <span class="na">content=</span><span class="s">&quot;no-cache&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>      <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;Pragma&quot;</span> <span class="na">content=</span><span class="s">&quot;no-cache&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>      <span class="nt">&lt;title&gt;&lt;ui:insert</span> <span class="na">name=</span><span class="s">&quot;title&quot;</span><span class="nt">&gt;</span>Application Title<span class="nt">&lt;/ui:insert&gt;&lt;/title&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/f:facet&gt;</span>
</span><span class='line'><span class="nt">&lt;/h:head&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Вертикальные табы в p:tabView</h2>

<p>Поскольку компоненты библиотеки основаны на jQueryUI, то для создания вертикальных табов можно использовать решение из <a href="http://jquery-ui.googlecode.com/svn/trunk/demos/tabs/vertical.html">этого демо</a>. Во первых необходимо добавить CSS код:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="c">/* Vertical Tabs</span>
</span><span class='line'><span class="c">----------------------------------*/</span>
</span><span class='line'><span class="nc">.ui-tabs-vertical</span> <span class="p">{</span> <span class="k">width</span><span class="o">:</span> <span class="m">55em</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="nc">.ui-tabs-vertical</span> <span class="nc">.ui-tabs-nav</span> <span class="p">{</span> <span class="k">padding</span><span class="o">:</span> <span class="m">.2em</span> <span class="m">.1em</span> <span class="m">.2em</span> <span class="m">.2em</span><span class="p">;</span> <span class="k">float</span><span class="o">:</span> <span class="k">left</span><span class="p">;</span> <span class="k">width</span><span class="o">:</span> <span class="m">12em</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="nc">.ui-tabs-vertical</span> <span class="nc">.ui-tabs-nav</span> <span class="nt">li</span> <span class="p">{</span> <span class="k">clear</span><span class="o">:</span> <span class="k">left</span><span class="p">;</span> <span class="k">width</span><span class="o">:</span> <span class="m">100</span><span class="o">%</span><span class="p">;</span> <span class="k">border-bottom-width</span><span class="o">:</span> <span class="m">1px</span> <span class="cp">!important</span><span class="p">;</span> <span class="k">border-right</span><span class="o">-</span><span class="k">width</span><span class="o">:</span> <span class="m">0</span> <span class="cp">!important</span><span class="p">;</span> <span class="k">margin</span><span class="o">:</span> <span class="m">0</span> <span class="m">-1px</span> <span class="m">.2em</span> <span class="m">0</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="nc">.ui-tabs-vertical</span> <span class="nc">.ui-tabs-nav</span> <span class="nt">li</span> <span class="nt">a</span> <span class="p">{</span> <span class="k">display</span><span class="o">:</span><span class="k">block</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="nc">.ui-tabs-vertical</span> <span class="nc">.ui-tabs-nav</span> <span class="nt">li</span><span class="nc">.ui-tabs-selected</span> <span class="p">{</span> <span class="k">padding-bottom</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span> <span class="k">padding-right</span><span class="o">:</span> <span class="m">.1em</span><span class="p">;</span> <span class="k">border-right</span><span class="o">-</span><span class="k">width</span><span class="o">:</span> <span class="m">1px</span><span class="p">;</span> <span class="k">border-right</span><span class="o">-</span><span class="k">width</span><span class="o">:</span> <span class="m">1px</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="nc">.ui-tabs-vertical</span> <span class="nc">.ui-tabs-panel</span> <span class="p">{</span> <span class="k">padding</span><span class="o">:</span> <span class="m">1em</span><span class="p">;</span> <span class="k">float</span><span class="o">:</span> <span class="k">right</span><span class="p">;</span> <span class="k">width</span><span class="o">:</span> <span class="m">40em</span><span class="p">;}</span>
</span></code></pre></td></tr></table></div></figure>


<p>А во вторых подключить класс к нужному tabView</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;p:tabView</span> <span class="na">styleClass=</span><span class="s">&quot;ui-tabs-vertical&quot;</span> <span class="nt">/&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Данное решение было найдено по мотивам данных вопросов на <a href="http://stackowerflow.com">StackOverflow</a>:
*   <a href="http://stackoverflow.com/q/6098319/600313">Make tabs appear vertically on the side when using PrimeFaces TabView</a>
*   <a href="http://stackoverflow.com/q/773074/600313">Vertical Tabs with JQuery?</a></p>

<p>Пока что это все :) При появлении еще каких нибудь заметок, обязуюсь выложить их на всеобщее обозрение.</p>
]]></content>
  </entry>
  
  
  
  
  
  <entry>
    <title type="html"><![CDATA[Установка связки Mercurial + UWSGI + Nginx + HTTPS на Ubuntu Server 10.04]]></title>
    <link href="http://eburtsev.github.com/2011/08/03/13/"/>
    <updated>2011-08-03T20:28:00+04:00</updated>
    <id>http://eburtsev.github.com/2011/08/03/13</id>
    <content type="html"><![CDATA[<p>Недавно появилась необходимость установить Mercurial сервер, используя в качестве фронтэнда nginx. В интернете довольно много информации на данную тему, но пришлось довольно много импровизировать что бы добиться результата. Итак, ниже представлен результат труда по настройке этой связки.</p>

<!--more-->


<p>Все нижеописанные действия производятся из под рута. Итак, приступим :)</p>

<h2>Установка необходимого софта</h2>

<h3>Python</h3>

<p>В первую очередь поставим Python.</p>

<pre><code>apt-get install python
</code></pre>

<p>Так же для удобства добавления сторонних PPA можно поставить python-software-properties:</p>

<pre><code>apt-get install python-software-properties
</code></pre>

<p>После этого PPA можно добавлять командой</p>

<pre><code>add-apt-repository ppa:xxx/yyy
</code></pre>

<h3>Mercurial</h3>

<p>Поскольку в репозитории Lucid Lynx находится версия mercurial&#8217;а, древняя как говно мамона, то подключаем PPA с новыми версиями:</p>

<pre><code>add-apt-repository ppa:mercurial-ppa/stable-snapshots
apt-get update
apt-get install mercurial
</code></pre>

<h3>Nginx</h3>

<p>В основном репозитории nginx отсутствует поэтому подключаем PPA и устанавливаем.</p>

<pre><code>add-apt-repository ppa:nginx/stable
apt-get update
apt-get install nginx
</code></pre>

<h3>uwsgi-python</h3>

<p>В качестве сервера python-приложений установим uwsgi-python.</p>

<pre><code>add-apt-repository ppa:uwsgi/release
apt-get update
apt-get install uwsgi-python
</code></pre>

<h2>Настройка</h2>

<p>Теперь после установки софта начинается самое сложное - настройка.
Во первых, рассмотрим структуру директорий, которая будет использоваться.</p>

<pre><code>/var/www/hosts/hg.server.net/conf    здесь будут расположены конфиги
/var/www/hosts/hg.server.net/logs    директория для логов
/var/www/hosts/hg.server.net/repos   директория, содержащая репозитории
</code></pre>

<h3>Mercurial + uwsgi</h3>

<p>Создадим файл описания UWSGI-приложения <code>/etc/uwsgi-python/apps-available/hgweb.xml</code> примерно такого содержания:</p>

<figure class='code'><figcaption><span>hgweb.xml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;uwsgi&gt;</span>
</span><span class='line'>  <span class="nt">&lt;socket&gt;</span>/var/run/uwsgi.hgweb.sock<span class="nt">&lt;/socket&gt;</span>
</span><span class='line'>  <span class="nt">&lt;master/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;workers&gt;</span>2<span class="nt">&lt;/workers&gt;</span>
</span><span class='line'>  <span class="cp">&lt;![CDATA[</span>
</span><span class='line'><span class="cp">     import uwsgi</span>
</span><span class='line'><span class="cp">     import os</span>
</span><span class='line'>
</span><span class='line'><span class="cp">     os.environ[&quot;HGENCODING&quot;] = &quot;UTF-8&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">     from mercurial import demandimport; demandimport.enable()</span>
</span><span class='line'><span class="cp">     from mercurial.hgweb.hgwebdir_mod import hgwebdir</span>
</span><span class='line'>
</span><span class='line'><span class="cp">     application = hgwebdir(&#39;/var/www/hosts/hg.server.net/conf/hgweb.config&#39;)</span>
</span><span class='line'><span class="cp"> ]]&gt;</span>
</span><span class='line'><span class="nt">&lt;/uwsgi&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Параметр socket задает адрес который будет прослушивать сервер. workers количество запущенных воркеров. Обратите внимание что в 14-ой строке необходимо указать правильный путь к конфигу hgweb, созданием которого мы сейчас и займемся.</p>

<p>Для этого создаем файл <code>/var/www/hosts/hg.server.net/conf/hgweb.config</code>:</p>

<figure class='code'><figcaption><span>hgweb.config</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ini'><span class='line'><span class="k">[web]</span>
</span><span class='line'><span class="na">push_ssl</span> <span class="o">=</span> <span class="s">true</span>
</span><span class='line'><span class="na">allow_push</span> <span class="o">=</span> <span class="s">*</span>
</span><span class='line'><span class="na">style</span> <span class="o">=</span> <span class="s">gitweb</span>
</span><span class='line'><span class="na">allow_archive</span> <span class="o">=</span> <span class="s">gz, zip, bz2</span>
</span><span class='line'>
</span><span class='line'><span class="k">[collections]</span>
</span><span class='line'><span class="na">/var/www/hosts/hg.server.net/repos/</span> <span class="o">=</span> <span class="s">/var/www/hosts/hg.server.net/repos/</span>
</span></code></pre></td></tr></table></div></figure>


<p>Во второй строке мы разрешаем проталкивать изменения только по SSL.
В третьей можно перечислить через запятую пользователей которым разрешено проталкивать изменения на сервер.
В четвертой выбирается стиль интерфейса. Мне больше всего нравится gitweb.
в последней строке необходимо установить корректные пути до репозиториев.
Теперь, для проверки корректности настроек временно поменяем строку <code>&lt;socket&gt;/var/run/uwsgi.hgweb.sock&lt;/socket&gt;</code> в файле hgweb.xml на <code>&lt;socket&gt;127.0.0.1:3031&lt;/socket&gt;</code> и запустим следующую команду:</p>

<pre><code>uwsgi-python -x /etc/uwsgi-python/apps-available/hgweb.xml
</code></pre>

<p>Если все настроено верно то никаких ошибок выведено не будет. И если зайти браузером по адресу <code>http://127.0.0.1:3031/</code> то отобразится список репозиториев. Если все нормально то меняем файл hgweb.xml обратно и создаем симлинк в <code>/etc/uwsgi-python/apps-enabled</code>:</p>

<pre><code>ln -s /etc/uwsgi-python/apps-{available,enabled}/hgweb.xml
</code></pre>

<p>Теперь можно переходить к следующему этапу.</p>

<h3>Nginx</h3>

<p>Создадим файл паролей при помощи утилиты htpasswd</p>

<pre><code>htpasswd -c /var/www/auth/.htpasswd &lt;username&gt;
</code></pre>

<p>Создаем конфиг /etc/nginx/sites-available/hg.server.net</p>

<figure class='code'><figcaption><span>hg.server.net</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class='nginx'><span class='line'><span class="k">server</span> <span class="p">{</span>
</span><span class='line'>  <span class="kn">listen</span>               <span class="mi">443</span><span class="p">;</span>
</span><span class='line'>  <span class="kn">listen</span>               <span class="mi">80</span><span class="p">;</span>
</span><span class='line'>  <span class="kn">server_name</span>          <span class="s">hg.server.net</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kn">ssl</span>                  <span class="no">on</span><span class="p">;</span>
</span><span class='line'>  <span class="kn">ssl_protocols</span>        <span class="s">SSLv3</span> <span class="s">TLSv1</span><span class="p">;</span>
</span><span class='line'>  <span class="kn">ssl_certificate</span>      <span class="s">/var/www/hosts/hg.server.net/ssl/ssl_certificate.crt</span><span class="p">;</span>
</span><span class='line'>  <span class="kn">ssl_certificate_key</span>  <span class="s">/var/www/hosts/hg.server.net/ssl/ssl_certificate.key</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kn">root</span>                 <span class="s">/var/www/hosts/hg.server.net/www</span><span class="p">;</span>
</span><span class='line'>  <span class="kn">access_log</span>           <span class="s">/var/www/hosts/hg.server.net/logs/access.log</span><span class="p">;</span>
</span><span class='line'>  <span class="kn">error_log</span>            <span class="s">/var/www/hosts/hg.server.net/logs/error.log</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Need for very big files</span>
</span><span class='line'>  <span class="kn">client_max_body_size</span> <span class="mi">100m</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kn">if</span> <span class="s">(</span> <span class="nv">$scheme</span> <span class="p">=</span> <span class="s">&quot;http&quot;</span> <span class="s">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kn">rewrite</span> <span class="s">^/(.*)</span>$  <span class="s">https://</span><span class="nv">$host/$1</span> <span class="s">permanent</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
</span><span class='line'>      <span class="kn">auth_basic</span>                  <span class="s">&quot;Mercurial</span> <span class="s">Repository&quot;</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">auth_basic_user_file</span>        <span class="s">/var/www/auth/.htpasswd</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">include</span>     <span class="s">uwsgi_params</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">uwsgi_param</span> <span class="s">REMOTE_PORT</span>     <span class="nv">$remote_port</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">uwsgi_param</span> <span class="s">SERVER_PORT</span>     <span class="nv">$server_port</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">uwsgi_param</span> <span class="s">SERVER_PROTOCOL</span> <span class="nv">$server_protocol</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">uwsgi_param</span> <span class="s">UWSGI_SCHEME</span>    <span class="nv">$scheme</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">uwsgi_param</span> <span class="s">SCRIPT_NAME</span>     <span class="s">/</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">uwsgi_param</span> <span class="s">AUTH_USER</span>       <span class="nv">$remote_user</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">uwsgi_param</span> <span class="s">REMOTE_USER</span>     <span class="nv">$remote_user</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">uwsgi_pass</span>  <span class="s">hgweb</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kn">location</span> <span class="s">/static/</span> <span class="p">{</span>
</span><span class='line'>      <span class="kn">rewrite</span>       <span class="s">/static/(.*)</span>  <span class="s">/</span><span class="nv">$1</span> <span class="s">break</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">root</span>          <span class="s">/usr/share/mercurial/templates/static</span><span class="p">;</span>
</span><span class='line'>      <span class="kn">expires</span> <span class="s">30d</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kn">location</span> <span class="p">~</span> <span class="sr">/\.</span> <span class="p">{</span>
</span><span class='line'>      <span class="kn">deny</span> <span class="s">all</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">upstream</span> <span class="s">hgweb</span> <span class="p">{</span>
</span><span class='line'>  <span class="kn">server</span> <span class="s">unix:/var/run/uwsgi.hgweb.sock</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Делаем симлинк для нашего конфига в <code>/etc/nginx/sites-enabled</code>:</p>

<pre><code>ln -s /etc/nginx/sites-{available,enabled}/hg.server.net
</code></pre>

<p>Запускаем сервисы</p>

<pre><code>service uwsgi-python start
service nginx start
</code></pre>

<p>Если все хорошо то зайдя по адресу <code>http://hg.server.net/</code> увидим список репозиториев.
Если это так то сделаем что бы все запускалось автоматически при старте системы и забудем о настройке.</p>

<h3>Автоматический запуск сервисов при загрузке</h3>

<p>Во первых убедитесь что сделали симлинки на конфиги.
Во вторых следует настроить сервисы для автоматического запуска:</p>

<pre><code>update-rc.d uwsgi-python defaults
update-rc.d nginx defaults
</code></pre>

<p>Все - настройка завершена, можно перезагрузиться и еще раз проверить работу.</p>
]]></content>
  </entry>
  
  
  
  
</feed>
